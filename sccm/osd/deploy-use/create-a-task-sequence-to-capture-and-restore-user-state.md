---
title: "Создание последовательности задач для записи и восстановления данных о пользовательской среде | Документы Майкрософт"
description: "Использование последовательностей задач System Center Configuration Manager для записи и восстановления данных о пользовательской среде в сценариях развертывания операционной системы."
ms.custom: na
ms.date: 06/07/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-osd
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: d566d85c-bf7a-40e7-8239-57640a1db5f4
caps.latest.revision: "7"
caps.handback.revision: "0"
author: Dougeby
ms.author: dougeby
manager: angrobe
ms.openlocfilehash: 4b3668094d576b1b8710f08b384aa2f7c5eb0cca
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2017
---
# <a name="create-a-task-sequence-to-capture-and-restore-user-state-in-system-center-configuration-manager"></a>Создание последовательности задач для записи и восстановления данных о пользовательской среде в System Center Configuration Manager

*Применимо к: System Center Configuration Manager (Current Branch)*

Вы можете использовать последовательности задач System Center Configuration Manager для записи и восстановления данных о пользовательской среде в тех сценариях развертывания операционной системы, где требуется сохранить пользовательскую среду текущей ОС. В зависимости от создаваемого типа последовательности задач шаги записи и восстановления могут включаться в состав последовательности задач автоматически. В других случаях может потребоваться ручное добавление таких шагов. В этом разделе описаны шаги, которые необходимо добавить в существующую последовательность задач для сбора и восстановления данных о пользовательской среде.  

##  <a name="BKMK_CaptureRestoreUserState"></a> Запись и восстановление данных о пользовательской среде  
 Чтобы записать и восстановить данные о пользовательской среде, необходимо добавить в последовательность задач следующие шаги:  

-   **Запросить хранилище состояний**. Этот шаг требуется, только если пользовательская среда сохраняется в точке миграции состояния.  

-   **Записать пользовательское состояние**. Этот шаг выполняет сбор данных пользовательской среды и сохраняет их в точке миграции состояния или на локальном компьютере (используя связи).  

-   **Восстановить пользовательское состояние**. Этот шаг восстанавливает данные пользовательской среды на конечном компьютере. Он может получать данные из точки миграции состояния или с конечного компьютера.  

-   **Освободить хранилище состояний**. Этот шаг требуется, только если пользовательская среда сохраняется в точке миграции состояния. Этот шаг удаляет данные с точки миграции состояния.  

 Ниже приведены процедуры добавления шагов последовательности задач для сбора и восстановления данных пользовательской среды. Дополнительные сведения о создании последовательностей задач см. в статье [Управление последовательностями задач для их автоматизации](manage-task-sequences-to-automate-tasks.md).  

#### <a name="to-add-task-sequence-steps-to-capture-the-user-state"></a>Добавление шагов последовательности задач для сбора данных о пользовательской среде  

1.  В списке **Последовательность задач** выберите последовательность задач и нажмите кнопку **Изменить**.  

2.  Если точка миграции состояния используется для хранения данных пользовательской среды, добавьте в нее шаг **Запросить хранилище состояний** . В диалоговом окне **Редактор последовательности задач** нажмите кнопку **Добавить**, наведите указатель на пункт **Пользовательское состояние**и щелкните **Запросить хранилище состояний**. Укажите для шага **Запросить хранилище состояний** перечисленные ниже свойства и параметры, а затем нажмите кнопку **Применить**.  

     На странице **Свойства** выполните следующие действия.  

    -   Введите имя и описание для шага.  

    -   Установите переключатель **захвата состояния компьютера**.  

    -   В поле **Число повторных попыток** укажите количество попыток сбора данных о пользовательской среде в случае возникновения ошибки.  

    -   В поле **Пауза между попытками (секунд)** укажите для последовательности задач интервал (в секундах) ожидания перед повторной попыткой сбора данных.  

    -   Установите флажок **Если учетной записи компьютера не удается соединиться с хранилищем состояний, использовать учетную запись для доступа к сети**, чтобы указать, используется ли [учетная запись для доступа к сети](../../core/plan-design/hierarchy/manage-accounts-to-access-content.md#a-namebkmknaaa-network-access-account) Configuration Manager для подключения к хранилищу состояний.  

     На вкладке **Параметры** укажите перечисленные ниже параметры:  

    -   Установите флажок **Продолжать при ошибке** , если требуется, чтобы последовательность задач в случае сбоя этого шага переходила к выполнению следующего шага.  

    -   Укажите условия, которые должны быть выполнены, прежде чем последовательность задач сможет продолжать выполнение в случае возникновения ошибки.  

3.  Добавьте шаг **Записать пользовательское состояние** в последовательность задач. В диалоговом окне **Редактор последовательности задач** нажмите кнопку **Добавить**, наведите указатель на пункт **Пользовательское состояние**и щелкните **Записать пользовательское состояние**. Укажите для шага **Записать пользовательское состояние** перечисленные ниже свойства и параметры, а затем нажмите кнопку **Применить**.  

    > [!IMPORTANT]  
    >  При добавлении этого шага к последовательности задач также следует задать переменную последовательности задач **OSDStateStorePath** , чтобы указать, где хранятся данные о состоянии пользователя. Если нужно сохранить состояние пользователя локально, не указывайте корневую папку, так как это может привести к сбою в последовательности задач. При хранении данных пользователей локально всегда следует использовать папку или подпапку. Сведения об этой переменной см. в статье [Записать пользовательское состояние. Переменные действия последовательности задач](../understand/task-sequence-action-variables.md#BKMK_CaptureUserState).  

     На странице **Свойства** выполните следующие действия.  

    -   Введите имя и описание для шага.  

    -   Укажите пакет, который содержит исходный файл USMT, использованный для сбора данных о пользовательской среде.  

    -   Укажите профили пользователей для записи:  

        -   установите переключатель **Захватить все профили пользователей, используя стандартные параметры** , чтобы записать все профили пользователей;  

        -   установите переключатель **Настройка захвата профилей пользователей** , чтобы указать отдельные профили пользователей для записи. Выберите файл конфигурации (miguser.xml, migsys.xml или migapp.xml), содержащий сведения о профиле пользователя. Здесь нельзя использовать файл конфигурации config.xml, но можно вручную добавить его в командную строку USMT, используя переменные OSDMigrageAdditionalCaptureOptions и OSDMigrateAdditionalRestoreOptions.

    -   Установите флажок **Включить запись подробных сведений в журнал** , чтобы указать степень детализации данных в файле журнале при возникновении ошибки.  

    -   Установите флажок **Пропустить файлы, использующие шифрованную файловую систему (EFS)**.  

    -   Установите переключатель **Скопировать, используя доступ к файловой системе** , чтобы указать следующие параметры.  

        -   **Продолжать при невозможности захвата некоторых файлов**. Этот параметр позволяет продолжить процесс миграции, даже если не удается записать некоторые файлы. Если отключить этот параметр, выполнение последовательности задач завершится сбоем, если не удастся записать какой-либо файл. Этот параметр по умолчанию включен.  

        -   **Захватить локально, используя ссылки, а не копируя файлы**. Этот параметр позволяет использовать функцию миграции с помощью жестких связей, доступную в средстве миграции пользовательской среды USMT 4.0. Этот параметр пропускается, если используются версии средства миграции пользовательской среды, предшествующие USMT 4.0.  

        -   **Выполнить захват в автономном режиме (только в ОС Windows PE)**. Этот параметр позволяет записывать пользовательскую среду из среды предустановки Windows без необходимости запуска существующей операционной системы. Этот параметр пропускается, если используются версии средства миграции пользовательской среды, предшествующие USMT 4.0.  

    -   Установите флажок **Захватить, используя службу VSS**. Этот параметр пропускается, если используются версии средства миграции пользовательской среды, предшествующие USMT 4.0.  

     На вкладке **Параметры** укажите перечисленные ниже параметры:  

    -   Установите флажок **Продолжать при ошибке** , если требуется, чтобы последовательность задач в случае сбоя этого шага переходила к выполнению следующего шага.  

    -   Укажите условия, которые должны быть выполнены, прежде чем последовательность задач сможет продолжать выполнение в случае возникновения ошибки.  

4.  Если точка миграции состояния используется для хранения данных о пользовательской среде, добавьте в последовательность шаг [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore). В диалоговом окне **Редактор последовательности задач** последовательно щелкните **Добавить**, **Пользовательское состояние**и **Освободить хранилище состояний**. Укажите следующие свойства и параметры для шага **Освободить хранилище состояний** и нажмите кнопку **ОК**.  

    > [!IMPORTANT]  
    >  Действие последовательности задач, выполняемое до шага **Освободить хранилище состояний** последовательности задач, должно быть успешно выполнено, прежде чем можно будет перейти к шагу **Освободить хранилище состояний** .  

     Введите имя и описание для шага на вкладке **Свойства** .  

     На вкладке **Параметры** укажите перечисленные ниже параметры.  

    -   Установите флажок **Продолжать при ошибке** , если требуется, чтобы последовательность задач в случае сбоя этого шага переходила к выполнению следующего шага.  

    -   Укажите условия, которые должны быть выполнены перед тем, как последовательность задач продолжит работу в случае возникновения ошибки.  

 Выполните развертывание этой последовательности задач, чтобы выполнить сбор данных о пользовательской среде на конечном компьютере. Дополнительные сведения о развертывании последовательностей задач см. в статье [Развертывание последовательности задач](../deploy-use/manage-task-sequences-to-automate-tasks.md#BKMK_DeployTS).  

#### <a name="to-add-task-sequence-steps-to-restore-the-user-state"></a>Добавление шагов последовательности задач для восстановления пользовательской среды  

1.  В списке **Последовательность задач** выберите последовательность задач и нажмите кнопку **Изменить**.  

2.  Добавьте шаг [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState) в последовательность задач. В диалоговом окне **Редактор последовательности задач** нажмите кнопку **Добавить**, наведите указатель на пункт **Пользовательское состояние**и щелкните **Восстановить пользовательское состояние**. Этот шаг устанавливает подключение к точке миграции состояния. Укажите для шага **Восстановить пользовательское состояние** перечисленные ниже свойства и параметры, а затем нажмите кнопку **ОК**.  

     На вкладке **Свойства** укажите перечисленные ниже свойства.  

    -   Введите имя и описание для шага.  

    -   Укажите пакет, который содержит средство миграции пользовательской среды, чтобы восстановить данные пользовательской среды.  

    -   Укажите профили пользователей, подлежащие восстановлению.  

        -   Чтобы восстановить все профили пользователей, выберите пункт **Восстановить все профили пользователей со стандартными параметрами** .  

        -   Чтобы восстановить профили отдельных пользователей, выберите **Настроить восстановление профиля пользователя**. Выберите файл конфигурации (miguser.xml, migsys.xml или migapp.xml), содержащий сведения о профиле пользователя. Здесь нельзя использовать файл конфигурации config.xml, но можно вручную добавить его в командную строку USMT, используя переменные OSDMigrageAdditionalCaptureOptions и OSDMigrateAdditionalRestoreOptions.

    -   Чтобы указать новый пароль для восстановленных профилей, выберите **Восстановить профили локальных пользователей компьютера** . Переносить пароли локальных профилей нельзя.  

        > [!NOTE]  
        >  Если у вас есть локальные учетные записи пользователей, а также используется шаг [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState) и выбран параметр **Записать все профили пользователей, используя стандартные параметры**, необходимо выбрать параметр **Восстановить профили локальных пользователей компьютера** в шаге [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState), иначе последовательность задач завершится со сбоем.  

    -   Если необходимо, чтобы шаг **Восстановить пользовательское состояние** продолжал свою работу даже при сбое в процессе восстановления того или иного файла, выберите пункт **Продолжать при невозможности восстановления некоторых файлов** .  

         Если пользовательская среда была сохранена с помощью локальных связей и ее не удалось восстановить, пользователь с правами администратора может вручную удалить жесткие связи, созданные для хранения данных, или запустить средство USMTUtils при помощи последовательности задач. Если для удаления жестких связей используется средство USMTUtils, добавьте шаг [Перезагрузить компьютер](../understand/task-sequence-steps.md#a-namebkmkrestartcomputera-restart-computer) после запуска этого средства.  

    -   Установите флажок **Включить запись подробных сведений в журнал** , чтобы указать степень детализации данных в файле журнале при возникновении ошибки.  

     На вкладке **Параметры** укажите перечисленные ниже параметры:  

    -   Установите флажок **Продолжать при ошибке** , если требуется, чтобы последовательность задач в случае сбоя этого шага переходила к выполнению следующего шага.  

    -   Укажите условия, которые должны быть выполнены, прежде чем последовательность задач сможет продолжать выполнение в случае возникновения ошибки.  

3.  Если точка миграции состояния используется для хранения данных о пользовательской среде, добавьте в последовательность шаг [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore). В диалоговом окне **Редактор последовательности задач** последовательно щелкните **Добавить**, **Пользовательское состояние**и **Освободить хранилище состояний**. Укажите следующие свойства и параметры для шага **Освободить хранилище состояний** и нажмите кнопку **ОК**.  

    > [!IMPORTANT]  
    >  Действие последовательности задач, выполняемое до шага **Освободить хранилище состояний** последовательности задач, должно быть успешно выполнено, прежде чем можно будет перейти к шагу **Освободить хранилище состояний** .  

     Введите имя и описание для шага на вкладке **Свойства** .  

     На вкладке **Параметры** укажите перечисленные ниже параметры.  

    -   Установите флажок **Продолжать при ошибке** , если требуется, чтобы последовательность задач в случае сбоя этого шага переходила к выполнению следующего шага.  

    -   Укажите условия, которые должны быть выполнены перед тем, как последовательность задач продолжит работу в случае возникновения ошибки.  

 Разверните эту последовательность задач, чтобы восстановить пользовательскую среду на конечном компьютере. Дополнительные сведения о развертывании последовательностей задач см. в статье [Развертывание последовательности задач](manage-task-sequences-to-automate-tasks.md#BKMK_DeployTS).  

## <a name="next-steps"></a>Дальнейшие действия
[Мониторинг развертывания последовательности задач](monitor-operating-system-deployments.md#BKMK_TSDeployStatus)
