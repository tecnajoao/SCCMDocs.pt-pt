---
title: "Резервное копирование сайтов | Документация Майкрософт"
description: "Сведения о создании резервных копий сайтов до сбоя или потери данных в System Center Configuration Manager."
ms.custom: na
ms.date: 6/5/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-other
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: f7832d83-9ae2-4530-8a77-790e0845e12f
caps.latest.revision: "22"
author: Brenduns
ms.author: brenduns
manager: angrobe
ms.openlocfilehash: 7deb00d4b67eabf3238907b337a9d0367c3d99cc
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2017
---
# <a name="back-up-a-configuration-manager-site"></a>Архивация сайта Configuration Manager

*Применимо к: System Center Configuration Manager (Current Branch)*

Подготовка вариантов по резервному копированию и восстановлению в целях исключения потери данных. Процедура резервного копирования и восстановления сайтов Configuration Manager помогает быстро восстанавливать сайты и иерархии с минимальной потерей данных.  

В этой статье описано, как создавать резервные копии сайтов. Сведения о восстановлении см. в статье [Recovery for Configuration Manager](/sccm/protect/understand/recover-sites) (Восстановление сайтов Configuration Manager).  

## <a name="considerations-before-creating-a-backup"></a>Предварительные требования  
-   **Если вы используете группу доступности SQL Server AlwaysOn для размещения базы данных сайта**, измените планы резервного копирования и восстановления (см. руководство по [подготовке к использованию SQL Server AlwaysOn](/sccm/core/servers/deploy/configure/sql-server-alwayson-for-a-highly-available-site-database#changes-for-site-backup)).

-   Configuration Manager может восстановить базу данных сайта из задачи обслуживания резервного копирования Configuration Manager или из резервной копии базы данных сайта, созданной с помощью другого процесса.   

    Например, базу данных сайта можно восстановить из резервной копии, созданной в составе плана обслуживания Microsoft SQL Server. Также можно использовать резервную копию, созданную с помощью Data Protection Manager (DPM) для резервного копирования базы данных сайта.

####  <a name="using-data-protection-manager-to-back-up-your-site-database"></a>Использование Data Protection Manager для резервного копирования базы данных вашего сайта
Вы можете использовать System Center 2012 Data Protection Manager (DPM) для резервного копирования базы данных вашего сайта.

Необходимо создать новую группу защиты в DPM для компьютера базы данных сайта. На странице **Выбор членов группы** мастера создания группы защиты выберите службу модуля записи SMS в списке источников данных, затем выберите базу данных сайта в качестве члена группы. Дополнительные сведения об использовании DPM для резервного копирования базы данных сайта см. в [библиотеке документации к Data Protection Manager](http://go.microsoft.com/fwlink/?LinkId=272772) в сети TechNet.  

> [!IMPORTANT]  
>  Configuration Manager не поддерживает создание резервных копий DPM для кластера SQL Server, который использует именованный экземпляр, но поддерживает создание таких копий для кластера SQL Server, который использует экземпляр SQL Server по умолчанию.  

 После восстановления базы данных сайта выполните необходимые действия в программе установки для восстановления сайта. Выберите вариант восстановления **Использовать базу данных сайта, восстановленную вручную**, чтобы использовать базу данных сайта, восстановленную с помощью Data Protection Manager.  

## <a name="backup-maintenance-task"></a>Задача обслуживания "Резервное копирование"
Резервное копирование сайтов Configuration Manager можно автоматизировать путем создания расписания для предопределенной задачи обслуживания "Резервное копирование сервера сайта". Эта задача:

-   выполняется по расписанию;
-   создает резервную копию базы данных сайта;
-   создает резервную копию конкретных разделов реестра;
-   создает резервную копию определенных файлов и папок;
-   создает резервную копию папки [CD.Latest](/sccm/core/servers/manage/the-cd.latest-folder).   

Запланируйте выполнение задачи резервного копирования сайта по умолчанию как минимум раз в 5 дней. Это связано с тем, что для Configuration Manager *данные отслеживания изменений в SQL Server* хранятся 5 дней  (подробнее об этом см. [здесь](/sccm/protect/understand/recover-sites#bkmk_SQLretention)).

Чтобы упростить процесс резервного копирования, вы можете создать файл **AfterBackup.bat**, который после успешного завершения задачи обслуживания "Резервное копирование" будет автоматически выполнять действия, необходимые после резервного копирования. Файл AfterBackup.bat обычно используется для архивации моментального снимка резервной копии в надежном расположении. Файл AfterBackup.bat также можно использовать для копирования файлов в папку резервной копии и запуска других дополнительных задач по резервному копированию.  

Процесс резервного копирования применяется к сайту центра администрирования и первичному сайту. Резервное копирование вторичных сайтов или серверов систем сайта не поддерживается.

Запущенная служба архивации Configuration Manager следует инструкциям, определенным в файле параметров архивации (**&lt;папка_установки_Configuration_Manager\>\Inboxes\Smsbkup.box\Smsbkup.ctl**). Чтобы изменить механизм работы службы резервного копирования, в файл параметров резервного копирования можно внести изменения.  

Сведения о состоянии резервного копирования сайта записываются в файл **Smsbkup.log** . Этот файл создается в конечной папке, указанной в свойствах задачи обслуживания "Резервное копирование сервера сайта.  

#### <a name="to-enable-the-site-backup-maintenance-task"></a>Включение задачи обслуживания "Резервное копирование сайта"  

1.  В консоли Configuration Manager последовательно выберите **Администрирование** > **Конфигурация сайта** > **Сайты**.  

2.  Выберите сайт, на котором требуется включить задачу обслуживания "Резервное копирование сайта".  

3.  На вкладке **Главная** в группе **Параметры** щелкните элемент **Задачи обслуживания сайта**.  

4.  Выберите **Резервное копирование сервера сайта**  >  **Изменить**.  

5.  Выберите **Включить эту задачу** > **Задать пути**, чтобы указать конечное расположение резервной копии. Можно выбрать один из следующих параметров.  

    > [!IMPORTANT]  
    >  Чтобы предотвратить несанкционированное изменение файлов резервной копии, храните эти файлы в безопасном месте. Наиболее безопасным расположением резервной копии является локальный диск, где папку с файлами можно защитить, настроив разрешения файловой системы NTFS. Configuration Manager не шифрует сохраняемые данные резервной копии.  

    -   **Локальный диск на сервере сайта для данных сайта и базы данных**: указывает, что файлы резервной копии для сайта и базы данных сайта хранятся по указанному пути на локальном диске сервера сайта. Перед запуском задачи резервного копирования необходимо создать локальную папку. Учетная запись локальной системы на сервере сайта должна иметь разрешения файловой системы NTFS на **запись** в локальную папку резервной копии сервера сайта. Учетная запись локальной системы на компьютере под управлением SQL Server должна иметь разрешения NTFS на **запись** в папку резервной копии базы данных сайта.  

    -   **Сетевой путь (UNC-имя) для данных сайта и базы данных**: указывает, что файлы резервной копии для сайта и базы данных сайта хранятся по указанному UNC-пути. Перед запуском задачи резервного копирования необходимо создать общую папку. Учетная запись компьютера сервера сайта и компьютера SQL Server (если SQL Server установлен на другом компьютере) должны обладать разрешением NTFS на **запись** в и разрешениями на общий доступ к общей сетевой папке.  

    -   **Локальные диски на сервере сайта и сервере SQL Server**: указывает, что файлы резервной копии для сайта хранятся по указанному пути на локальном диске сервера сайта, а файлы резервной копии для базы данных сайта хранятся по указанному пути на локальном диске сервера базы данных сайта. Перед запуском задачи резервного копирования необходимо создать локальные папки. Учетная запись компьютера сервера сайта должна иметь разрешение NTFS на **запись** в папку, созданную на сервере сайта. Учетная запись компьютера SQL Server должна иметь разрешение NTFS на **запись** в папку, созданную на сервере базы данных сайта. Этот параметр доступен только в случае, если база данных сайта не установлена на сервере сайта.  

    > [!NOTE]  
    >   Параметр перехода к папке расположения резервной копии доступен только в случае, если указан UNC-путь к папке резервной копии.

    > Имя папки или общей папки, используемое для конечного расположения резервной копии, не поддерживает символы Юникода.  

6.  Настройте расписание для задачи резервного копирования сайта. Рекомендуется задать такое расписание, в соответствии с которым резервное копирование будет выполняться во время низкой нагрузки. Чтобы в случае сбоя сайта максимально сохранить данные при наличии иерархии, настройте расписание, которое выполняется как минимум дважды в неделю.  

    Если консоль Configuration Manager запускается на сервере сайта, который настраивается для резервного копирования, задача обслуживания "Резервное копирование сервера сайта" использует для расписания местное время. Если консоль Configuration Manager запускается на компьютере, удаленном от сайта, который настраивается для резервного копирования, задача обслуживания "Резервное копирование сервера сайта" использует для расписания время в формате UTC.  

7.  Укажите, следует ли создавать оповещение в случае сбоя задачи резервного копирования, нажмите кнопку **ОК**, а затем нажмите кнопку **ОК** еще раз. Если этот параметр выбран, Configuration Manager создаст критическое оповещение о сбое резервного копирования, которое появится в узле **Оповещения** в рабочей области **Мониторинг**.  

 Далее убедитесь, что запущена задача обслуживания "Резервное копирование сервера сайта", чтобы гарантировать создание резервных копий.  

#### <a name="to-verify-that-the-backup-site-server-maintenance-task-is-running"></a>Проверка запуска задачи обслуживания "Резервное копирование сервера сайта"  
Убедитесь в успешном запуске задачи обслуживания "Резервное копирование сайта", проверив любое из следующих условий.  

-   Проверьте метку времени в файлах в конечной папке резервной копии, созданной задачей обслуживания. Метка времени должна быть обновлена значением, совпадающим со значением времени, на которое было запланировано последнее выполнение задачи.  

-   В узле **Состояние компонента** в рабочей области **Мониторинг** проверьте сообщения о состоянии для SMS_SITE_BACKUP. Если резервное копирование сайта завершено успешно, будет отображен ИД сообщения 5035, означающий, что резервное копирование выполнено без ошибок.  

-   Если задача обслуживания "Резервное копирование сайта" настроена на создание оповещения в случае сбоя процесса резервного копирования, проверьте узел **Оповещения** в рабочей области **Мониторинг** на наличие ошибок резервного копирования.  

-   В папке &lt;*папка_установки_Configuration_Manager*>\Logs проверьте файл Smsbkup.log на наличие ошибок и предупреждений. В случае успешного завершения резервного копирования отображается сообщение `Backup completed` с меткой времени и ИД сообщения `STATMSG: ID=5035`.  

    > [!TIP]  
    >  В случае сбоя задачи обслуживания "Резервное копирование" можно перезапустить задачу резервного копирования, остановив и повторно запустив службу SMS_SITE_BACKUP.  

## <a name="archive-the-backup-snapshot"></a>Архивация моментального снимка резервной копии  
Во время своего первого выполнения задача обслуживания "Резервное копирование сервера сайта" создает моментальный снимок резервной копии, который можно использовать для восстановления сервера сайта после сбоя. Если задача выполняется повторно во время следующих циклов, она создает новый снимок резервной копии, который перезаписывает предыдущий. Таким образом, для сайта существует только один моментальный снимок резервной копии. Получить снимки, созданные ранее, невозможно.  

Существует ряд следующих причин, по которым рекомендуется иметь несколько архивных моментальных снимков резервной копии.  

-   Вполне возможно, что носитель резервной копии может быть поврежден, потерян или на нем может находиться только часть резервной копии. Восстановление потерявшего работоспособность автономного первичного сайта из более ранней резервной копии является лучшим решением, чем восстановление без резервных копий. Для сервера сайта в иерархии резервная копия должна находиться в рамках срока хранения отслеживания изменений SQL Server. В противном случае резервная копия не требуется.  

-   Нарушение работоспособности сайта может оставаться незамеченным в течение нескольких циклов резервного копирования Может потребоваться воспользоваться моментальным снимком резервной копии, созданным до повреждения сайта. Этот принцип применим к автономному первичному сайту и сайтам в иерархии, где для резервной копии действует срок хранения отслеживания изменений SQL Server.  

-   У сайта вообще может не быть моментального снимка резервной копии, если, например, происходит сбой задачи обслуживания "Резервное копирование сервера сайта". Поскольку перед началом процедуры создания резервной копии текущих данных задача резервного копирования удаляет предыдущий моментальный снимок резервной копии, допустимый моментальный снимок резервной копии отсутствует.  

## <a name="using-the-afterbackupbat-file"></a>Использование файла AfterBackup.bat  
После успешного резервного копирования сайта задача «Резервное копирование сервера сайта» автоматически попытается запустить файл AfterBackup.bat. Файл AfterBackup.bat необходимо создать вручную в папке &lt;*ConfigMgrInstallationFolder*>\Inboxes\Smsbkup. Если файл AfterBackup.bat существует и хранится в правильной папке, после завершения задачи резервного копирования он запустится автоматически.

Файл AfterBackup.bat используется для архивации моментального снимка резервной копии в конце каждой операции резервного копирования. Он автоматически выполняет другие задачи после резервного копирования, которые не входят в задачу обслуживания "Резервное копирование сервера сайта". Файл AfterBackup.bat интегрируется с операциями архивации и резервного копирования, обеспечивая тем самым архивацию каждого нового моментального снимка резервной копии.

Если файл AfterBackup.bat отсутствует, задача резервного копирования пропустит его без какого-либо воздействия на операцию резервного копирования. Чтобы убедиться в успешном запуске файла AfterBackup.bat задачей резервного копирования сайта, в узле **Состояние компонента** в области **Мониторинг** просмотрите сообщения о состоянии для SMS_SITE_BACKUP. Если задача успешно запустила командный файл AfterBackup.bat, появится ИД сообщения 5040.  

> [!TIP]  
>  Чтобы создать файл AfterBackup.bat для архивации файлов резервного копирования сервера сайта, необходимо использовать в этом пакетном файле средство командной строки для копирования например, [Robocopy](http://go.microsoft.com/fwlink/p/?LinkId=228408). Например, можно создать файл AfterBackup.bat и в первой его строке добавить примерно такую команду: `Robocopy E:\ConfigMgr_Backup \\ServerName\ShareName\ConfigMgr_Backup /MIR`.  

 Хотя исходно файл AfterBackup.bat предназначен для архивации моментальных снимков резервных копий, вы можете настроить этот файл для выполнения дополнительных задач по окончании каждой операции резервного копирования.  

##  <a name="supplemental-backup-tasks"></a>Дополнительные задачи архивации  
Задача обслуживания "Резервное копирование сервера сайта" позволяет получить моментальный снимок резервной копии файлов сервера сайта и базы данных сайте, но при создании стратегии резервного копирования необходимо учитывать, что есть другие элементы, резервные копии которых не создаются. Следующие разделы содержат сведения о реализации стратегии резервного копирования Configuration Manager.  

### <a name="back-up-custom-reporting-services-reports"></a>Резервное копирование пользовательских отчетов служб отчетов  
Если вы изменили встроенные отчеты служб отчетов или создали пользовательские отчеты, резервное копирование файлов базы данных сервера отчетов становится важной частью стратегии резервного копирования. В резервную копию сервера отчетов должна входить резервная копия исходных файлов отчетов и моделей, ключей шифрования, пользовательских сборок или расширений, файлов конфигурации, пользовательских представлений SQL Server, которые применяются в пользовательских отчетах, пользовательских хранимых процедур и т. д.  

> [!IMPORTANT]  
>  Когда Configuration Manager обновляется до более поздней версии, предустановленные отчеты заменяются новыми отчетами. В случае изменения предопределенного отчета необходимо выполнить резервное копирование отчета, после чего восстановить его в службах Reporting Services.  

 Дополнительные сведения о резервном копировании пользовательских отчетов в службах Reporting Services см. в разделе [Операции резервного копирования и восстановления для установки Reporting Services](https://technet.microsoft.com/library/ms155814\(v=sql.120\).aspx) электронной документации по SQL Server 2014.  

### <a name="back-up-content-files"></a>Резервное копирование файлов содержимого  
В библиотеке содержимого Configuration Manager хранятся все файлы содержимого для обновлений ПО, приложений, развертываний операционных систем и пр. Библиотека содержимого находится на сервере сайта и в каждой точке распространения. Задача обслуживания "Резервное копирование сервера сайта" не предусматривает создание резервной копии библиотеки содержимого или исходных файлов пакетов. При возникновении сбоя на сервере сайта сведения о файлах в библиотеке содержимого восстанавливается в базе данных сайта, однако необходимо вручную восстановить библиотеку содержимого и исходные файлы пакета на сервере сайта.  

-   **Библиотека содержимого**. Перераспределение содержимого в точки распространения становится возможным только после того, как будет восстановлена библиотека содержимого. Когда запускается перераспределение содержимого, Configuration Manager копирует файлы из библиотеки содержимого на сервере сайта в точки распространения. Библиотека содержимого для сервера сайтов располагается в папке SCCMContentLib, которая обычно находится на диске с наибольшим количеством свободного пространства на момент установки сайта.  

-   **Исходные файлы пакетов**. Обновление содержимого в точках распространения становится возможным только после того, как будут восстановлены исходные файлы пакетов. Когда запускается обновление содержимого, Configuration Manager копирует новые или измененные файлы из источника пакета в библиотеку содержимого, откуда, в свою очередь, они копируются в соответствующие точки распространения. Найти местоположение источника пакета для всех пакетов и приложений можно с помощью следующего запроса SQL Server: `SELECT * FROM v_Package`. Опознать сайт источника пакета можно по первым трем символам идентификатора пакета. Например, если пакет имеет идентификатор CEN00001, то код сайта источника — CEN. Исходные файлы пакетов должны восстанавливаться в том же месте, где они находились до сбоя.  

 Убедитесь, что в резервную копию файловой системы сервера сайта включены местоположения и библиотеки содержимого, и источников пакетов.  

### <a name="back-up-custom-software-updates"></a>Резервное копирование пользовательских обновлений программного обеспечения  
 System Center Updates Publisher 2011 — это автономное средство, позволяющее публиковать пользовательские обновления программного обеспечения в службах Windows Server Update Services (WSUS), синхронизировать эти обновления с Configuration Manager, оценивать их соответствие и развертывать их на клиентах. В качестве репозитория обновления программного обеспечения в Updates Publisher используется локальная база данных. Если вы используете Updates Publisher для управления пользовательскими обновлениями программного обеспечения, решите, нужно ли вам включать базу данных Updates Publisher в план резервного копирования. Подробные сведения о приложении Updates Publisher см. в статье [System Center Updates Publisher 2011](http://go.microsoft.com/fwlink/p/?LinkId=228726) библиотеки технического центра System Center.  

 Для резервного копирования базы данных Updates Publisher используйте следующую процедуру.  

#### <a name="to-back-up-the-updates-publisher-2011-database"></a>Резервное копирование базы данных Updates Publisher 2011  

1.  На компьютере, где работает Updates Publisher, перейдите к файлу базы данных Updates Publisher (Scupdb.sdf) в папке %*USERPROFILE*%\AppData\Local\Microsoft\System Center Updates Publisher 2011\5.00.1727.0000\\. У каждого пользователя, запускающего Updates Publisher, имеется собственная база данных.  

2.  Скопируйте файл базы данных в конечную папку резервного копирования. Например, если конечной папкой резервного копирования является папка E:\ConfigMgr_Backup, можно скопировать файл базы данных Updates Publisher в папку E:\ConfigMgr_Backup\SCUP2011.  

    > [!TIP]  
    >  Если на компьютере имеется более одного файла базы данных, имеет смысл сохранить файл во вложенной папке, указывающей на профиль пользователя, с которым связан этот файл. Например, один файл базы данных может хранится в папке E:\ConfigMgr_Backup\SCUP2011\User1, а другой — в папке E:\ConfigMgr_Backup\SCUP2011\User2.  

## <a name="user-state-migration-data"></a>Данные миграции состояния пользователя  
Вы можете использовать последовательности задач Configuration Manager для записи и восстановления данных о пользовательской среде в тех сценариях развертывания операционной системы, где требуется сохранить пользовательскую среду текущей ОС. Папки, в которых хранятся данные о пользовательской среде, указаны в свойствах точки миграции состояния. Для этих данных не создаются резервные копии при выполнении задачи обслуживания "Резервное копирование сервера сайта". Поэтому в плане резервного копирования необходимо предусмотреть ручное резервное копирование папок, в которых хранятся данные о миграции пользовательской среды.   

### <a name="to-determine-the-folders-used-to-store-user-state-migration-data"></a>Определение папок, в которых хранятся данные о миграции пользовательской среды  

1.  В консоли Configuration Manager щелкните **Администрирование**.  

2.  В рабочей области **Администрирование** разверните узел **Конфигурация сайта** и выберите **Серверы и роли системы сайта**.  

3.  Выберите систему сайта, в которой размещена роль миграции пользовательской среды, и выберите роль **Точка миграции состояния** в списке **Роли системы сайта**.  


4.  На вкладке **Роль сайта** в группе **Свойства** нажмите кнопку **Свойства**.  
5.  Папки, в которых хранятся данные о миграции пользовательской среды, перечислены в разделе **Сведения о папке** на вкладке **Общие** .  



## <a name="about-the-sms-writer-service"></a>Сведения о службе модуля записи SMS  
Модуль записи SMS — эта служба, которая взаимодействует со службой теневого копирования томов (VSS) во время резервного копирования. Чтобы обеспечить успешное резервное копирование сайта Configuration Manager, службу модуля записи SMS необходимо запустить заранее.  

### <a name="purpose"></a>Назначение  
Модуль записи SMS регистрируется в службе VSS и выполняет привязку к ее интерфейсам и событиям. Когда служба VSS осуществляет широковещательную рассылку событий или передает определенные уведомления модулю записи SMS, модуль записи SMS отвечает на уведомление и выполняет соответствующее действие. Модуль записи SMS считывает файл параметров резервной копии (smsbkup.ctl), расположенный в папке &lt;*путь_установки_Configuration_Manager*>\inboxes\smsbkup.box, и определяет файлы и данные, подлежащие архивации. На основании этих данных и определенных данных из раздела и подразделов реестра SMS модуль записи SMS создает состоящие из различных компонентов метаданные. При получении запроса модуль отправляет метаданные в службу VSS. Затем служба VSS отправляет метаданные запрашивающему приложению — диспетчеру резервного копирования Configuration Manager. Диспетчер резервного копирования выбирает данные для резервного копирования и отправляет их модулю записи SMS через службу VSS. Модуль записи SMS выполняет соответствующее действие для подготовки к резервному копированию. Затем готовая к созданию моментального снимка служба VSS отправляет событие, модуль записи SMS останавливает работу всех служб Configuration Manager и фиксирует действия Configuration Manager во время создания снимка. После создания моментального снимка модуль записи SMS перезапускает службы и действия.  

Модуль записи SMS устанавливается автоматически. На момент запроса приложением VSS действий по резервному копированию и восстановлению модуль записи должен быть уже запущен.  

### <a name="writer-id"></a>Идентификатор модуля записи  
Модуль записи SMS имеет следующий идентификатор: 03ba67dd-dc6d-4729-a038-251f7018463b.  

### <a name="permissions"></a>Разрешения  
Служба модуля записи SMS должна запускаться под учетной записью локальной системы.  

### <a name="volume-shadow-copy-service"></a>Служба теневого копирования томов  
Служба VSS — это набор API COM, который реализует платформу, позволяющую проводить резервное копирование томов одновременно с непрекращающимися действиями приложений в системе по записи в тома. Служба VSS предоставляет единообразный интерфейс, позволяющий координировать операции пользовательских приложений по обновлению данных на диске (служба записи SMS) с действиями приложений по резервному копированию (служба диспетчера резервного копирования). См. дополнительные сведения о [службе теневого копирования томов](http://go.microsoft.com/fwlink/p/?LinkId=241968) в техническом центре Windows Server.  

## <a name="next-steps"></a>Дальнейшие действия
Создав резервную копию, попробуйте с ее помощью [восстановить сайт](/sccm/protect/understand/recover-sites). Так вы ознакомитесь с процессом восстановления, прежде чем примените его, и убедитесь в пригодности резервной копии для этих целей.  
