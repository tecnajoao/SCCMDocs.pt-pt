---
title: "Реплики базы данных для точек управления | Документы Майкрософт"
description: "Используйте реплики базы данных, чтобы снизить нагрузку на ЦП сервера базы данных сайта, которую создают точки управления."
ms.custom: na
ms.date: 10/06/2016
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-other
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: b06f781b-ab25-4d9a-b128-02cbd7cbcffe
caps.latest.revision: "9"
author: Brenduns
ms.author: brenduns
manager: angrobe
ms.openlocfilehash: 130c053c9f2a1817dd85b1f3c01285aab19d59cb
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2017
---
# <a name="database-replicas-for-management-points-for-system-center-configuration-manager"></a>Реплики базы данных для точек управления для System Center Configuration Manager

*Применимо к: System Center Configuration Manager (Current Branch)*

Первичные сайты System Center Configuration Manager могут использовать реплики базы данных, чтобы снизить нагрузку на ЦП сервера базы данных сайта, которую создают точки управления при обработке запросов от клиентов.  

-   Если точка управления использует реплику базы данных, она запрашивает данные с компьютера SQL Server, где размещается эта реплика базы данных, а не с сервера базы данных сайта.  

-   Это может помочь снизить требования к мощности ЦП на сервере базы данных сайта за счет разгрузки часто выполняемых задач обработки, связанных с клиентами.  Примеры часто выполняемых задач обработки для клиентов включают в себя сайты с большим количеством клиентов, часто отправляющих запросы на политику клиентов.  


##  <a name="bkmk_Prepare"></a> Подготовка к использованию реплик базы данных  
**Сведения о репликах базы данных для точек управления:**  

-   Реплика — это частичная копия базы данных сайта, которая реплицируется в отдельный экземпляр SQL Server:  

    -   Первичные сайты поддерживают выделенную реплику базу данных для каждой точки управления на сайте (вторичные сайты не поддерживают реплики базы данных).  

    -   Одну реплику базы данных могут использовать сразу несколько точек управления с одного сайта.  

    -   В SQL Server можно разместить несколько реплик базы данных для использования разными точками управления, если каждая из них выполняется в отдельном экземпляре SQL Server.  

-   Реплики синхронизируют копию базы данных сайта по фиксированному графику на основе данных, опубликованных сервером базы данных сайтов специально для этой цели.  

-   Точки управления можно настроить на использование реплики в процессе установки точки управления или позднее путем повторной настройки ранее установленной точки управления на использование реплики базы данных.  

-   Регулярно осуществляйте мониторинг сервера базы данных сайта и каждого сервера реплики базы данных, чтобы убедиться в выполнении репликации между этими серверами и соответствии производительности сервера реплики базы данных необходимому уровню производительности сайта и клиента.  

**Необходимые условия для реплик баз данных:**  

-   **Требования к SQL Server:**  

    -   SQL Server, где размещается реплика базы данных, должен соответствовать тем же требованиям, что и сервер базы данных сайта. Однако серверу реплики не требуется та же версия или тот же выпуск SQL Server, которые используются для сервера базы данных сайта, пока он работает под управлением поддерживаемой версии или поддерживаемого выпуска SQL Server. Дополнительные сведения см. в статье [Поддержка версий SQL Server в System Center Configuration Manager](../../../../core/plan-design/configs/support-for-sql-server-versions.md).  

    -   Служба SQL Server на компьютере, на котором размещается реплика базы данных, должна выполняться с **системной** учетной записью.  

    -   Как для SQL Server с базой данных сайта, так и для SQL Server с репликой базы данных должен быть установлен компонент **Репликация SQL Server** .  

    -   База данных сайта должна **опубликовать** реплику базы данных, а каждый удаленный сервер реплики базы данных должен **подписаться** на эти опубликованные данные.  

    -   Как для SQL Server с базой данных сайта, так и для SQL Server с репликой базы данных следует указать параметр **Max Text Repl Size** , равный 2 ГБ. Пример того, как выполнить эту настройку в SQL Server 2012, см. в разделе [Configure the max text repl size Server Configuration Option (Настройка параметра конфигурации сервера "max text repl size")](http://go.microsoft.com/fwlink/p/?LinkId=273960).  

-   **Самозаверяющий сертификат:** для настройки реплики базы данных необходимо создать самозаверяющий сертификат на сервере реплики базы данных и сделать его доступным для каждой точки управления, которая будет использовать этот сервер реплики базы данных.  

    -   Точка управления, установленная на сервере реплики базы данных, получит доступ к сертификату автоматически.  

    -   Чтобы сертификат был доступен и для удаленных точек управления, его следует экспортировать, а затем добавить в хранилище сертификатов **Доверенные лица** в удаленной точке управления.  

-   **Уведомление клиента:** для поддержки клиентских уведомлений с репликой базы данных для точки управления необходимо настроить соединение между сервером базы данных сайта и сервером реплики базы данных для **SQL Server Service Broker**. Для этого необходимо выполнить следующее:  

    -   Настроить каждую базу данных с использованием сведений о другой базе данных.  

    -   Осуществить обмен сертификатами между двумя базами данных для обеспечения безопасной связи.  

**Ограничения при использовании реплик базы данных:**  

-   После настройки веб-сайта на публикацию реплик базы данных вместо стандартных инструкций следует руководствоваться описанными ниже процедурами.  

    -   [Удаление сервера сайта, который публикует реплику базы данных](#BKMK_DBReplicaOps_Uninstall)  

    -   [Перемещение базы данных сервера сайта, которая публикует реплику базы данных](#BKMK_DBReplicaOps_Move)  

-   **Обновление до System Center Configuration Manager**. Перед обновлением сайта System Center 2012 Configuration Manager до версии System Center Configuration Manager необходимо отключить реплики базы данных для точек управления.  После обновления сайта можно перенастроить реплики базы данных для точек управления.  

-   **Несколько реплик на одном сервере SQL Server**. Если вы настраиваете сервер реплики базы данных, чтобы разместить несколько реплик базы данных для точек управления (каждая реплика должна находиться в отдельном экземпляре), необходимо использовать измененный скрипт настройки (из шага 4 в следующем разделе) для предотвращения перезаписи самозаверяющего сертификата, используемого ранее настроенными репликами базы данных на этом сервере.  

##  <a name="BKMK_DBReplica_Config"></a> Настройка реплик базы данных  
Чтобы настроить реплику базы данных, необходимо выполнить следующие действия:  

-   [Шаг 1. Настройка сервера базы данных сайта на публикацию реплики базы данных](#BKMK_DBReplica_ConfigSiteDB)  

-   [Шаг 2. Настройка сервера реплики базы данных](#BKMK_DBReplica_ConfigSrv)  

-   [Шаг 3. Настройка точек управления на использование реплики базы данных](#BKMK_DBReplica_ConfigMP)  

-   [Шаг 4. Настройка самозаверяющего сертификата для сервера реплики базы данных](#BKMK_DBReplica_Cert)  

-   [Шаг 5. Настройка SQL Server Service Broker для сервера реплики базы данных](#BKMK_DBreplica_SSB)  

###  <a name="BKMK_DBReplica_ConfigSiteDB"></a> Шаг 1. Настройка сервера базы данных сайта на публикацию реплики базы данных  
 Следующая процедура используется в качестве примера настройки сервера базы данных сайта на компьютере Windows Server 2008 R2 для публикации реплики базы данных. При наличии другой версии операционной системы обратитесь к документации по имеющейся операционной системе и соответствующим образом измените действия в этой процедуре.  

##### <a name="to-configure-the-site-database-server"></a>Настройка сервера базы данных сайта  

1.  На сервере базы данных сайта задайте автоматический запуск агента SQL Server.  

2.  На сервере базы данных сайта создайте локальную группу пользователей с именем **ConfigMgr_MPReplicaAccess**. Чтобы включить синхронизацию серверов реплики базы данных с опубликованной репликой базы данных, в эту группу необходимо добавить учетную запись компьютера для каждого сервера реплики базы данных, используемого на этом сайте.  

3.  На сервере базы данных сайта настройте общий файловый ресурс с именем **ConfigMgr_MPReplica**.  

4.  Добавьте следующие разрешения для общего ресурса **ConfigMgr_MPReplica** :  

    > [!NOTE]  
    >  Если агент SQL Server использует учетную запись, отличную от учетной записи локальной системы, замените SYSTEM именем учетной записи из следующего списка.  

    -   **Разрешения для общего ресурса**.  

        -   SYSTEM: **Запись**  

        -   ConfigMgr_MPReplicaAccess: **Чтение**  

    -   **Разрешения NTFS**.  

        -   SYSTEM: **Полный доступ**  

        -   ConfigMgr_MPReplicaAccess: **Чтение**, **Чтение и выполнение**, **Список содержимого папки**  

5.  С помощью **SQL Server Management Studio** подключитесь к базе данных сайта и выполните следующую хранимую процедуру как запрос: **spCreateMPReplicaPublication**.  

После выполнения хранимой процедуры сервер базы данных сайта будет настроен для публикации реплики базы данных.  

###  <a name="BKMK_DBReplica_ConfigSrv"></a> Шаг 2. Настройка сервера реплики базы данных  
Сервер реплики базы данных — это компьютер, на котором выполняется SQL Server и на котором размещена реплика базы данных сайта, используемая точками управления. Сервер реплики базы данных по фиксированному расписанию синхронизирует свою копию базы данных с репликой базы данных, опубликованной сервером базы данных сайта.  

Сервер реплики базы данных должен соответствовать тем же требованиям, что и сервер базы данных сайта. Однако выпуск или версия SQL Server на сервере реплики базы данных может отличаться от выпуска или версии, запущенной на сервере базы данных сайта. Дополнительные сведения о поддерживаемых версиях SQL Server см. в статье [Поддержка версий SQL Server для System Center Configuration Manager](../../../../core/plan-design/configs/support-for-sql-server-versions.md).  

> [!IMPORTANT]  
>  Служба SQL Server на компьютере, на котором размещается реплика база данных, должна выполняться с системной учетной записью.  

Следующая процедура используется в качестве примера настройки сервера реплики базы данных на компьютере Windows Server 2008 R2. При наличии другой версии операционной системы обратитесь к документации по имеющейся операционной системе и соответствующим образом измените действия в этой процедуре.  

##### <a name="to-configure-the-database-replica-server"></a>Настройка сервера реплики базы данных  

1.  На сервере реплики базы данных задайте автоматический запуск агента SQL Server.  

2.  На сервере реплики базы данных с помощью **SQL Server Management Studio** подключитесь к локальному серверу, найдите папку **Репликация** , щелкните "Локальные подписки" и выберите **Создать подписки** , чтобы запустить **мастер создания подписки**.  

    1.  На странице **Публикация** в списке **Издатель** выберите **Найти издатель SQL Server**, введите имя сервера базы данных сайта, а затем нажмите кнопку **Подключить**.  

    2.  Выберите **ConfigMgr_MPReplica**, а затем нажмите кнопку **Далее**.  

    3.  На странице **Расположение агента распространителя** выберите параметр **Выполнять каждый агент на своем подписчике (подписки по запросу)**, а затем нажмите кнопку **Далее**.  

    4.  На странице **Подписчики** выполните одно из следующих действий.  

        -   На сервере реплики базы данных выберите существующую базу данных, которую будет использовать реплика базы данных, а затем нажмите кнопку **ОК**.  

        -   Чтобы создать новую базу данных для реплики базы данных, щелкните **Создать базу данных** . На странице **Создание базы данных** укажите имя базы данных, а затем нажмите кнопку **ОК**.  

    5.  Чтобы продолжить, нажмите кнопку **Далее** .  

    6.  На странице **Безопасность агента распространителя** в строке "Соединение с подписчиком" диалогового окна нажмите кнопку свойств **(.…)**, а затем настройте параметры безопасности для соединения.  

        > [!TIP]  
        >  Кнопка свойств, **(….)**, находится в четвертом столбце окна отображения.  

        **Параметры безопасности.**  

        -   Настройте учетную запись, используемую для запуска процесса агента распространителя (учетную запись процесса).  

            -   Если агент SQL Server выполняется как локальная система, выберите параметр **Выполнять с учетной записью службы "SQL Server, агент" (с точки зрения безопасности это не лучшее решение)**.  

            -   Если агент SQL Server выполняется под другой учетной записью, выберите параметр **Использовать следующую учетную запись Windows**, а затем настройте эту учетную запись. Можно указать учетную запись Windows или учетную запись SQL Server.  

            > [!IMPORTANT]  
            >  Учетной записи, которая используется для запуска агента распространителя, необходимо предоставить разрешения к издателю как "Подписка по запросу". Сведения о настройке этих разрешений см. в статье [Безопасность агента распространителя](http://go.microsoft.com/fwlink/p/?LinkId=238463) в библиотеке TechNet для SQL Server.  

        -   Параметру **Соединиться с распространителем**задайте значение **Путем олицетворения учетной записи процесса**.  

        -   Параметру **Соединиться с подписчиком**задайте значение **Путем олицетворения учетной записи процесса**.  

         После настройки параметров безопасности подключения нажмите кнопку **ОК** , чтобы их сохранить, а затем нажмите кнопку **Далее**.  

    7.  На странице **Расписание синхронизации** в списке **Расписание агента** выберите пункт **Задать расписание**, а затем настройте параметр **Создание расписания задания**. Для периодичности выполнения выберите значение **Ежедневно**, для повтора — каждые **5 минут**, а для продолжительности — **Нет даты окончания**. Нажмите кнопку **Далее** , чтобы сохранить расписание, а затем нажмите кнопку **Далее** еще раз.  

    8.  На странице **Действия мастера** установите флажок **Создать подписку(-и)**и нажмите кнопку **Далее**.  

    9. На странице **Завершение работы мастера** нажмите кнопку **Готово**, а затем нажмите кнопку **Закрыть** , чтобы завершить работу мастера.  

3.  Сразу после завершения работы мастера создания подписки воспользуйтесь **SQL Server Management Studio** для подключения к базе данных сервера реплики базы данных, а затем выполните следующий запрос, чтобы включить свойство базы данных TRUSTWORTHY:  `ALTER DATABASE <MP Replica Database Name> SET TRUSTWORTHY ON;`  

4.  Просмотрите состояние синхронизации, чтобы убедиться в успешной синхронизации подписки.  

    -   На компьютере подписчика выполните следующие действия.  

        -   В **SQL Server Management Studio**подключитесь к серверу реплики базы данных и разверните узел **Репликация**.  

        -   Разверните узел **Локальные подписки**, правой кнопкой мыши щелкните подписку на публикацию базы данных сайта, а затем в контекстном меню выберите пункт **Просмотр состояния синхронизации**.  

    -   На компьютере издателя выполните следующие действия.  

        -   В **SQL Server Management Studio**, подключитесь к компьютеру базы данных сайта, правой кнопкой щелкните папку **Репликация** , а затем в контекстном меню выберите команду **Запустить монитор репликации**.  

5.  Чтобы включить интеграцию среды CLR для реплики базы данных, подключитесь к реплике базы данных на сервере реплики базы данных с помощью **SQL Server Management Studio** и выполните следующую хранимую процедуру как запрос: **exec sp_configure 'clr enabled', 1; RECONFIGURE WITH OVERRIDE**.  

6.  Для каждой точки управления, которая использует сервер реплики базы данных, добавьте учетную запись компьютера точек управления в локальную группу **Администраторы** на этом сервере реплики базы данных.  

    > [!TIP]  
    >  Выполнять это действие для точки управления, установленной на сервере реплики базы данных, необязательно.  

 Теперь точки управления могут использовать реплику базы данных.  

###  <a name="BKMK_DBReplica_ConfigMP"></a> Шаг 3. Настройка точек управления на использование реплики базы данных  
 Во время установки роли точки управления точку управления на первичном сайте можно настроить для использования реплики базы данных. Или можно перенастроить существующую точку управления.  

 Используйте следующие сведения, чтобы настроить точку управления для использования реплики базы данных.  

-   **Настройка новой точки управления** В мастере, используемом для установки точки управления, на странице **База данных точки управления** выберите параметр **Использовать реплику базы данных**и укажите полное доменное имя компьютера, на котором размещена реплика базы данных. Затем для параметра **Имя базы данных сайта Configuration Manager**укажите имя базы данных для реплики базы данных на этом компьютере.  

-   **Настройка ранее установленной точки управления**Откройте станицу свойств точки управления, перейдите на вкладку **База данных точки управления** , выберите параметр **Использовать реплику базы данных**, а затем укажите полное доменное имя компьютера, на котором размещена реплика базы данных. Затем для параметра **Имя базы данных сайта Configuration Manager**укажите имя базы данных для реплики базы данных на этом компьютере.  

-   **Для каждой точки управления, использующей реплику базы данных**, необходимо вручную добавить учетную запись компьютера сервера точки управления в роль **db_datareader** реплики базы данных.  

Кроме настройки точки управления для использования сервера реплики базы данных в ней необходимо включить параметр **Проверка подлинности Windows** в **IIS** . Для этого выполните следующие действия.  

1.  Откройте **диспетчер служб IIS**.  

2.  Выберите веб-сайт, используемый точкой управления, и откройте компонент **Проверка подлинности**.  

3.  Задайте параметру **Проверка подлинности Windows** значение **Включено**, а затем закройте **диспетчер служб IIS**.  

###  <a name="BKMK_DBReplica_Cert"></a> Шаг 4. Настройка самозаверяющего сертификата для сервера реплики базы данных  
 На сервере реплики базы данных необходимо создать самозаверяющий сертификат и сделать его доступным для каждой точки управления, которая будет использовать этот сервер реплики базы данных.  

 Точка управления, установленная на сервере реплики базы данных, получит доступ к сертификату автоматически. Чтобы сертификат был доступен и для удаленных точек управления, его следует экспортировать, а затем добавить в хранилище сертификатов "Доверенные лица" в удаленной точке управления.  

 Следующие процедуры используются в качестве примера настройки самозаверяющего сертификата на сервере реплики базы данных для компьютера Windows Server 2008 R2. При наличии другой версии операционной системы обратитесь к документации по имеющейся операционной системе и соответствующим образом измените действия в этих процедурах.  

##### <a name="to-configure-a-self-signed-certificate-for-the-database-replica-server"></a>Настройка самозаверяющего сертификата для сервера реплики базы данных  

1.  На сервере реплики базы данных откройте командную строку PowerShell с правами администратора, а затем запустите следующую команду: **set-executionpolicy UnRestricted**.  

2.  Скопируйте следующий сценарий PowerShell и сохраните его как файл с именем **CreateMPReplicaCert.ps1**. Поместите копию файла в корневую папку системного раздела сервера реплики базы данных.  

    > [!IMPORTANT]  
    >  При настройке нескольких реплик базы данных на одном сервере SQL Server для каждой последующей настроенной реплики необходимо использовать измененную версию этого сценария для выполнения данной процедуры. См. статью  [Вспомогательный сценарий для дополнительных реплик базы данных на одном сервере SQL Server](#bkmk_supscript).  

    ```  
    # Script for creating a self-signed certificate for the local machine and configuring SQL Server to use it.  

    Param($SQLInstance)  

    $ConfigMgrCertFriendlyName = "ConfigMgr SQL Server Identification Certificate"  

    # Get local computer name  
    $computerName = "$env:computername"  

    # Get the sql server name  
    #$key="HKLM:\SOFTWARE\Microsoft\SMS\MP"  
    #$value="SQL Server Name"  
    #$sqlServerName= (Get-ItemProperty $key).$value  
    #$dbValue="Database Name"  
    #$sqlInstance_DB_Name= (Get-ItemProperty $key).$dbValue  

    $sqlServerName = [System.Net.Dns]::GetHostByName("localhost").HostName   
    $sqlInstanceName = "MSSQLSERVER"  
    $SQLServiceName = "MSSQLSERVER"  

    if ($SQLInstance -ne $Null)  
    {  
        $sqlInstanceName = $SQLInstance  
        $SQLServiceName = "MSSQL$" + $SQLInstance  
    }  

    # Delete existing cert if one exists  
    function Get-Certificate($storename, $storelocation)  
    {   
        $store=new-object System.Security.Cryptography.X509Certificates.X509Store($storename,$storelocation)   
        $store.Open([Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)   
        $store.Certificates   
    }   

    $cert = Get-Certificate "My" "LocalMachine" | ?{$_.FriendlyName -eq $ConfigMgrCertFriendlyName}   
    if($cert -is [Object])  
    {  
        $store = new-object System.Security.Cryptography.X509Certificates.X509Store("My","LocalMachine")   
        $store.Open([Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)   
        $store.Remove($cert)  
        $store.Close()  

        # Remove this cert from Trusted People too...  
        $store = new-object System.Security.Cryptography.X509Certificates.X509Store("TrustedPeople","LocalMachine")   
        $store.Open([Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)   
        $store.Remove($cert)  
        $store.Close()      
    }  

    # Create the new cert  
    $name = new-object -com "X509Enrollment.CX500DistinguishedName.1"  
    $name.Encode("CN=" + $sqlServerName, 0)  

    $key = new-object -com "X509Enrollment.CX509PrivateKey.1"  
    $key.ProviderName = "Microsoft RSA SChannel Cryptographic Provider"  
    $key.KeySpec = 1  
    $key.Length = 1024  
    $key.SecurityDescriptor = "D:PAI(A;;0xd01f01ff;;;SY)(A;;0xd01f01ff;;;BA)(A;;0x80120089;;;NS)"  
    $key.MachineContext = 1  
    $key.Create()  

    $serverauthoid = new-object -com "X509Enrollment.CObjectId.1"  
    $serverauthoid.InitializeFromValue("1.3.6.1.5.5.7.3.1")  
    $ekuoids = new-object -com "X509Enrollment.CObjectIds.1"  
    $ekuoids.add($serverauthoid)  
    $ekuext = new-object -com "X509Enrollment.CX509ExtensionEnhancedKeyUsage.1"  
    $ekuext.InitializeEncode($ekuoids)  

    $cert = new-object -com "X509Enrollment.CX509CertificateRequestCertificate.1"  
    $cert.InitializeFromPrivateKey(2, $key, "")  
    $cert.Subject = $name  
    $cert.Issuer = $cert.Subject  
    $cert.NotBefore = get-date  
    $cert.NotAfter = $cert.NotBefore.AddDays(3650)  
    $cert.X509Extensions.Add($ekuext)  
    $cert.Encode()  

    $enrollment = new-object -com "X509Enrollment.CX509Enrollment.1"  
    $enrollment.InitializeFromRequest($cert)  
    $enrollment.CertificateFriendlyName = "ConfigMgr SQL Server Identification Certificate"  
    $certdata = $enrollment.CreateRequest(0x1)  
    $enrollment.InstallResponse(0x2, $certdata, 0x1, "")  

    # Add this cert to the trusted peoples store  
    [Byte[]]$bytes = [System.Convert]::FromBase64String($certdata)  

    $trustedPeople = new-object System.Security.Cryptography.X509certificates.X509Store "TrustedPeople", "LocalMachine"  
    $trustedPeople.Open([Security.Cryptography.X509Certificates.OpenFlags]::ReadWrite)  
    $trustedPeople.Add([Security.Cryptography.X509Certificates.X509Certificate2]$bytes)  
    $trustedPeople.Close()  

    # Get thumbprint from cert  
    $sha = new-object System.Security.Cryptography.SHA1CryptoServiceProvider  
    $certHash = $sha.ComputeHash($bytes)  
    $certHashCharArray = "";  
    $certThumbprint = "";  

    # Format the bytes into a hexadecimal string  
    foreach($byte in $certHash)  
    {  
        $temp = ($byte | % {"{0:x}" -f $_}) -join ""  
        $temp = ($temp | % {"{0,2}" -f $_})  
        $certHashCharArray = $certHashCharArray+ $temp;  
    }  
    $certHashCharArray = $certHashCharArray.Replace(' ', '0');  

    # SQL needs the thumbprint in lower case  
    foreach($char in $certHashCharArray)  
    {  
        [System.String]$myString = $char;  
        $certThumbprint = $certThumbprint + $myString.ToLower();  
    }  

    # Configure SQL to use this cert  
    $path = "HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL"  
    $subKey = (Get-ItemProperty $path).$sqlInstanceName  
    $realPath = "HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\" + $subKey + "\MSSQLServer\SuperSocketNetLib"  
    $certKeyName = "Certificate"  
    Set-ItemProperty -path $realPath -name $certKeyName -Type string -Value $certThumbprint  

    # restart sql service  
    Restart-Service $SQLServiceName -Force  
    ```  

3.  На сервере реплики базы данных выполните следующую команду, которая применяется к конфигурации SQL Server.  

    -   Выполните следующие действия для заданного по умолчанию экземпляра SQL Server. Правой кнопкой мыши щелкните файл **CreateMPReplicaCert.ps1** , а затем в контекстном меню выберите команду **Выполнить с помощью PowerShell**. Во время выполнения сценарий создает самозаверяющий сертификат и настраивает SQL Server для его использования.  

    -   Выполните следующие действия для именованного экземпляра SQL Server. С помощью PowerShell выполните команду **%path%\CreateMPReplicaCert.ps1 xxxxxx** , где **xxxxxx** является именем экземпляра SQL Server.  

    -   После завершения сценария убедитесь, что агент SQL Server запущен. Если это не так, перезапустите агент SQL Server.  

##### <a name="to-configure-remote-management-points-to-use-the-self-signed-certificate-of-the-database-replica-server"></a>Настройка удаленных точек управления для использования самозаверяющего сертификата сервера реплики базы данных  

1.  На сервере реплики базы данных выполните приведенные ниже инструкции по экспорту самозаверяющего сертификата сервера:  

    1.  Нажмите кнопку **Пуск**, выберите пункт **Выполнить**и введите **mmc.exe.** В пустой консоли щелкните **Файл**, а затем выберите команду **Добавить или удалить оснастку**.  

    2.  В диалоговом окне **Добавление или удаление оснасток** выберите **Сертификаты** из списка **Доступные оснастки**и нажмите кнопку **Добавить**.  

    3.  В диалоговом окне **Оснастка диспетчера сертификатов** выберите пункт **Учетная запись компьютера**и нажмите кнопку **Далее**.  

    4.  В диалоговом окне **Выбор компьютера** выберите **Локальный компьютер: (компьютер, на котором запущена эта консоль)** и нажмите кнопку **Готово**.  

    5.  В диалоговом окне **Добавление или удаление оснасток** нажмите кнопку **ОК**.  

    6.  В консоли разверните узел **Сертификаты (локальный компьютер)**, затем разверните узел **Личные**и выберите **Сертификаты**.  

    7.  Правой кнопкой мыши щелкните сертификат с понятным именем **идентификационного сертификата SQL Server Configuration Manager**, в контекстном меню выберите **Все задачи**, а затем — **Экспорт**.  

    8.  Завершите работу **Мастера экспорта сертификатов** , оставив параметры по умолчанию, и сохраните сертификат с расширением файла **.cer** .  

2.  На компьютере точки управления выполните следующие действия по добавлению самозаверяющего сертификата сервера реплики базы данных в хранилище сертификатов "Доверенные лица" в точке управления.  

    1.  Повторите предыдущие шаги с 1.a по 1.e, чтобы настроить оснастку MMC **Сертификат** на компьютере точки управления.  

    2.  В консоли разверните узел **Сертификаты (Локальный компьютера)**, разверните узел **Доверенные лица**, щелкните правой кнопкой мыши пункт **Сертификаты**, выберите **Все задачи**, после чего выберите **Импортировать** , чтобы открыть **Мастер импорта сертификатов**.  

    3.  На странице **Файл для импорта** выберите сертификат, сохраненный в шаге 1.h, после чего нажмите кнопку **Далее**.  

    4.  На странице **Хранилище сертификатов** выберите **Разместить все сертификаты в следующем хранилище**, установив для параметра **Хранилище сертификатов** значение **Доверенные лица**и нажмите кнпоку **Далее**.  

    5.  Нажмите кнопку **Готово** , чтобы закрыть мастер и завершить настройку сертификата на точке управления.  

###  <a name="BKMK_DBreplica_SSB"></a> Шаг 5. Настройка SQL Server Service Broker для сервера реплики базы данных  
Для поддержки клиентских уведомлений с репликой базы данных для точки управления необходимо настроить соединение между сервером базы данных сайта и сервером реплики базы данных для SQL Server Service Broker. Для этого потребуется настроить в каждой базе данных сведения о другой базе данных и обменять сертификаты между двумя базами данных для защиты соединения.  

> [!NOTE]  
>  Перед использованием следующей процедуры сервер реплики базы данных должен успешно завершить процесс первоначальной синхронизации с сервером базы данных сайта.  

 Следующая процедура не изменяет порт Service Broker, настроенный в SQL Server для сервера базы данных сайта или сервера реплики базы данных. Напротив, она настраивает каждую базу данных для связи с другой базой данных, используя правильный порт Service Broker.  

 Используйте описанную ниже процедуру, чтобы настроить Service Broker для сервера базы данных сайта и сервера реплики базы данных.  

##### <a name="to-configure-the-service-broker-for-a-database-replica"></a>Настройка Service Broker для реплики базы данных  

1.  Используйте **SQL Server Management Studio** для подключения к серверу реплики базы данных, а затем выполните следующий запрос, чтобы включить Service Broker на сервере реплики базы данных: **ALTER DATABASE &lt;имя_реплики_базы_данных\> SET ENABLE_BROKER, HONOR_BROKER_PRIORITY ON WITH ROLLBACK IMMEDIATE**.  

2.  Далее на сервере реплики базы данных настройте Service Broker для уведомления клиентов и экспорта сертификата Service Broker. Чтобы сделать это, запустите хранимую процедуру SQL Server, которая настраивает Service Broker и экспортирует сертификат в составе единой операции. При запуске хранимой процедуры необходимо указать полное доменное имя сервера реплики базы данных, имя базы данных реплики базы данных и расположение для экспорта файла сертификата.  

     Выполните следующий запрос, чтобы настроить нужные сведения на сервере реплики базы данных и экспортировать сертификат для сервера реплики базы данных: **EXEC sp_BgbConfigSSBForReplicaDB '&lt;полное_доменное_имя_SQL_Server_реплики\>', '&lt;имя_реплики_базы_данных\>', '&lt;путь_к_файлу_резервной_копии_сертификата\>'**.  

    > [!NOTE]  
    >  Если сервер реплики базы данных не находится на экземпляре SQL Server по умолчанию, для этого шага необходимо указать имя экземпляра в дополнение к имени базы данных реплики. Для этого замените **&lt;имя_базы_данных_реплики\>** на **&lt;имя_экземпляра\\имя_базы_данных_реплики\>**.  

     После экспорта сертификата с сервера реплики базы данных поместите копию сертификата на сервер базы данных первичного сайта.  

3.  Используйте **SQL Server Management Studio** для подключения к базе данных первичного сайта. После подключения к базе данных первичного сайта выполните запрос для импорта сертификата и укажите порт Service Broker, используемый на сервере реплики базы данных, полное доменное имя сервера реплики базы данных и имя базы данных реплики базы данных. При этом для базы данных первичного сайта настраивается использование Service Broker для связи с базой данных на сервере реплики базы данных.  

     Выполните следующий запрос для импорта сертификата на сервере реплики базы данных и укажите необходимые сведения: **EXEC sp_BgbConfigSSBForRemoteService 'REPLICA', '&lt;порт SQL Service Broker\>', '&lt;путь_к_файлу_сертификата\>', '&lt;полное_доменное_имя_SQL_Server_реплики\>', '&lt;имя_реплики_базы_данных\>'**.  

    > [!NOTE]  
    >  Если сервер реплики базы данных не находится на экземпляре SQL Server по умолчанию, для этого шага необходимо указать имя экземпляра в дополнение к имени базы данных реплики. Для этого замените **&lt;имя_базы_данных_реплики\>** на **\имя_экземпляра\\имя_базы_данных_реплики\>**.  

4.  Далее на сервере базы данных сайта выполните следующую команду, чтобы экспортировать сертификат для сервера базы данных сайта: **EXEC sp_BgbCreateAndBackupSQLCert '&lt;путь_к_файлу_резервной_копии_сертификата\>'**.  

     После экспорта сертификата с сервера базы данных сайта поместите копию сертификата на сервер реплики базы данных.  

5.  Используйте **SQL Server Management Studio** для подключения к базе данных сервера реплики базы данных. После подключения к базе данных сервера реплики базы данных выполните запрос для импорта сертификата и укажите код первичного сайта, а также порт Service Broker, который используется на сервере базы данных сайта. При этом для базы данных реплики базы данных настраивается использование Service Broker для связи с базой данных первичного сайта.  

     Выполните следующий запрос для импорта сертификата с сервера базы данных сайта: **EXEC sp_BgbConfigSSBForRemoteService '&lt;код_сайта\>', '&lt;порт SQL Service Broker\>', '&lt;путь_к_файлу_сертификата\>'**.  

 Через несколько минут после завершения конфигурации базы данных сайта и базы данных реплики базы данных диспетчер уведомлений на первичном сайте настроит беседу Service Broker для клиентских уведомлений из базы данных первичного сайта в реплику базы данных.  

###  <a name="bkmk_supscript"></a> Вспомогательный сценарий для дополнительных реплик базы данных на одном сервере SQL Server  
 При использовании сценария из шага 4 для настройки самозаверяющего сертификата для сервера реплики базы данных на сервере SQL Server, где уже есть копия реплики базы данных, которую вы планируете продолжить использовать, необходимо воспользоваться измененной версией исходного сценария. Следующие изменения не позволяют сценарию удалить существующий сертификат на сервере и обеспечивают создание последующих сертификатов с уникальными понятными именами.  Внесите в исходный сценарий следующие изменения:  

-   Закомментируйте (запретите выполнение) каждую строку между записями сценария **# Delete existing cert if one exists** (Удаление существующего сертификата при его наличии) и **# Create the new cert**(Создание нового сертификата). Чтобы сделать это, добавьте  **#**  в качестве первого символа каждой соответствующей строки.  

-   Для каждой последующей реплики базы данных, которая настраивается с помощью этого сценария, обновляйте понятное имя для сертификата.  Для этого измените строку **$enrollment.CertificateFriendlyName = "ConfigMgr SQL Server Identification Certificate"** , заменив **ConfigMgr SQL Server Identification Certificate** новым именем, например  **ConfigMgr SQL Server Identification Certificate1**.  

##  <a name="BKMK_DBReplicaOps"></a> Управление конфигурациями реплик базы данных  
 При использовании реплики базы данных на сайте следует руководствоваться сведениями в дальнейших разделах этой статьи, связанными с процессом удаления реплики базы данных, удаления сайта, использующего реплику базы данных, или перемещения базы данных сайта на новую установку SQL Server. При применении данных в следующих разделах для удаления публикаций используйте рекомендации для удаления репликации транзакций в версии SQL Server, используемой для реплики базы данных. Например, если используется SQL Server 2008 R2, см. [Руководство. Удаление публикации (программирование репликации на Transact-SQL)](http://go.microsoft.com/fwlink/p/?LinkId=273934).  

> [!NOTE]  
>  После восстановления базы данных сайта, для которой были настроены реплики баз данных, перед использованием реплик необходимо заново настроить каждую реплику базы данных, создав публикации и подписки.  

###  <a name="BKMK_UninstallDbReplica"></a> Удаление реплики базы данных  
 При использовании реплики базы данных для точки управления может потребоваться удалить реплику базы данных на какое-то время, а затем заново настроить ее использование. Например, необходимо удалить реплики баз данных перед обновлением сайта Configuration Manager до нового пакета обновления. После завершения обновления сайта можно восстановить использование реплики базы данных.  

 Выполните следующие действия для удаления реплики базы данных.  

1.  В рабочей области **Администрирование** консоли Configuration Manager откройте раздел **Конфигурация сайта**, затем выберите пункт **Серверы и роли системы сайта** и в области сведений выберите сервер системы сайта, где размещена точка управления, использующая удаляемую реплику базы данных.  

2.  В области **Системные роли сайта** щелкните пункт **Точка управления** правой кнопкой мыши и выберите **Свойства**.  

3.  На вкладке **База данных точки управления** выберите команду **Использовать базу данных сайта** , чтобы настроить для точки управления использование базы данных сайта, а не ее реплики. Затем нажмите кнопку **ОК** , чтобы сохранить настройки.  

4.  Затем используйте **SQL Server Management Studio** для выполнения следующих задач.  

    -   Удалите публикацию для реплики базы данных с сервера базы данных сайта.  

    -   Удалите подписку для реплики базы данных с сервера базы данных сайта.  

    -   Удалите базу данных реплики с сервера.  

    -   Отключите публикацию и распространение на сервере базы данных сайта. Для отключения публикации и распространения щелкните правой кнопкой мыши папку "Репликация", а затем выберите команду **Отключить публикацию и распространение**.  

5.  После удаления публикации, подписки, базы данных реплики, а также выключения публикации на сервере базы данных сайта реплика базы данных удаляется.  

###  <a name="BKMK_DBReplicaOps_Uninstall"></a> Удаление сервера сайта, который публикует реплику базы данных  
 Перед удалением сайта, на котором опубликована реплика базы данных, используйте следующие действия для очистки публикации и всех подписок.  

1.  Удалите публикацию реплики базы данных из базы данных сервера сайта, используя **SQL Server Management Studio** .  

2.  Используйте **SQL Server Management Studio** , чтобы удалить подписку реплики базы данных с каждого удаленного сервера SQL Server, на котором размещена реплика базы данных для этого сайта.  

3.  Удаление сайта.  

###  <a name="BKMK_DBReplicaOps_Move"></a> Перемещение базы данных сервера сайта, которая публикует реплику базы данных  
 При перемещении базы данных сайта на новый компьютер выполните следующие действия.  

1.  Удалите публикацию реплики базы данных из базы данных сервера сайта, используя **SQL Server Management Studio** .  

2.  Удалите подписку на реплику базы данных с каждого сервера реплики базы данных для этого сайта, используя **SQL Server Management Studio** .  

3.  Перемещение базы данных на новый компьютер с SQL Server. Дополнительные сведения см. в разделе [Modify the site database configuration](../../../../core/servers/manage/modify-your-infrastructure.md#bkmk_dbconfig) статьи [Modify your System Center Configuration Manager infrastructure](../../../../core/servers/manage/modify-your-infrastructure.md) .  

4.  Повторно создайте публикацию для реплики базы данных на сервере базы данных сайта. Дополнительные сведения см. в разделе [Шаг 1. Настройка сервера базы данных сайта на публикацию реплики базы данных](#BKMK_DBReplica_ConfigSiteDB) этой статьи.  

5.  Повторно создайте подписки для реплики базы данных на каждом сервере реплики базы данных. Дополнительные сведения см. в разделе [Шаг 2. Настройка сервера реплики базы данных](#BKMK_DBReplica_ConfigSrv) этой статьи.  
