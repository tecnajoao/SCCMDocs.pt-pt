---
title: "SQL Server AlwaysOn | Документация Майкрософт"
description: "Планирование работы с группами доступности SQL Server AlwaysOn совместно с System Center Configuration Manager."
ms.custom: na
ms.date: 7/31/2017
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-other
ms.tgt_pltfrm: na
ms.topic: get-started-article
ms.assetid: 58d52fdc-bd18-494d-9f3b-ccfc13ea3d35
caps.latest.revision: "16"
author: Brenduns
ms.author: brenduns
manager: angrobe
ms.openlocfilehash: c746365238e1255d73387a9496521bb03a56b21b
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2017
---
# <a name="prepare-to-use-sql-server-always-on-availability-groups-with-configuration-manager"></a>Подготовка к использованию групп доступности SQL Server AlwaysOn для Configuration Manager

*Применимо к: System Center Configuration Manager (Current Branch)*

Подготовьте System Center Configuration Manager к использованию групп доступности SQL Server AlwaysOn для обеспечения высокого уровня доступности и аварийного восстановления базы данных сайта.  
Configuration Manager поддерживает использование групп доступности:
-     для первичных сайтов и сайтов центра администрирования;
-     в локальной среде или в Microsoft Azure.

В среде Microsoft Azure вы можете повысить уровень доступности базы данных сайта, используя *группы доступности Azure*. Дополнительные сведения о группах доступности Azure см. в статье [Управление доступностью виртуальных машин](https://azure.microsoft.com/documentation/articles/virtual-machines-windows-manage-availability/).

>  [!Important]   
>  Прежде чем продолжить, изучите инструкции по настройке SQL Server и групп доступности SQL Server. В этом руководстве предполагается, что вы знакомы с библиотекой документации и процедурами SQL Server.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии
Ниже описаны поддерживаемые сценарии использования групп доступности с Configuration Manager. См. дополнительные сведения о [настройке группы доступности для Configuration Manager](/sccm/core/servers/deploy/configure/configure-aoag).


-      [Создание группы доступности для использования с Configuration Manager](/sccm/core/servers/deploy/configure/configure-aoag#create-and-configure-an-availability-group).
-     [Настройка сайта для использования группы доступности](/sccm/core/servers/deploy/configure/configure-aoag#configure-a-site-to-use-the-database-in-the-availability-group).
-     [Добавление членов синхронной реплики в группу доступности с размещенной базой данных сайта или их удаление из нее](/sccm/core/servers/deploy/configure/configure-aoag#add-and-remove-synchronous-replica-members).
-     [Настройка реплик асинхронной фиксации](/sccm/core/servers/deploy/configure/configure-aoag#configure-an-asynchronous-commit-repilca) (требуется Configuration Manager 1706 или более поздней версии).
-     [Восстановление сайта из реплики асинхронной фиксации](/sccm/core/servers/deploy/configure/configure-aoag#use-the-asynchronous-replica-to-recover-your-site) (требуется Configuration Manager 1706 или более поздней версии).
-     [Перемещение базы данных сайта из группы доступности в именованный экземпляр или экземпляр автономного сервера SQL Server по умолчанию](/sccm/core/servers/deploy/configure/configure-aoag#stop-using-an-availability-group).


## <a name="prerequisites"></a>Предварительные требования
На все сценарии распространяются указанные ниже требования. Если к определенному сценарию применимы дополнительные условия, они будут подробно описаны вместе со сценарием.   

### <a name="configuration-manager-accounts-and-permissions"></a>Учетные записи и разрешения Configuration Manager
**Сервер сайта для доступа к членам реплики.**   
Учетная запись компьютера сервера сайта должна входить в группу **Локальные администраторы** на каждом компьютере, входящем в группу доступности.

### <a name="sql-server"></a>SQL Server
**Версия.**  
Каждая реплика в группе доступности должна выполнять версию SQL Server, поддерживаемую используемой версией Configuration Manager. На разных узлах группы доступности могут работать разные версии SQL Server, если такая возможность поддерживается SQL Server.

**Выпуск.**  
Необходимо использовать выпуск *Enterprise* сервера SQL Server.

**Учетная запись.**  
Каждый экземпляр SQL Server может работать под учетной записью пользователя домена (**учетной записью службы**) или под учетной записью, не входящей в домен. Все реплики в группе могут иметь разную конфигурацию. В соответствии с [рекомендациями для SQL Server](/sql/sql-server/install/security-considerations-for-a-sql-server-installation#before-installing-includessnoversionincludesssnoversion-mdmd) следует использовать учетную запись с минимальными необходимыми разрешениями.

-   Для SQL Server 2016 на сайте MSDN опубликовано руководство по [настройке учетных записей службы Windows и разрешений](/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions).
-   Чтобы использовать учетную запись, не входящую в домен, необходимо применить сертификаты. Дополнительные сведения см. в статье [Использование сертификатов для конечной точки зеркального отображения базы данных (Transact-SQL)](https://docs.microsoft.com/sql/database-engine/database-mirroring/use-certificates-for-a-database-mirroring-endpoint-transact-sql).


См. дополнительные сведения о [создании конечной точки зеркального отображения базы данных для групп доступности AlwaysOn](/sql/database-engine/availability-groups/windows/database-mirroring-always-on-availability-groups-powershell).

### <a name="availability-group-configurations"></a>Конфигурации групп доступности
**Члены реплик.**  
-   Группа доступности должна иметь по меньшей мере одну конечную точку.
-   До выхода версии 1706 можно было использовать не более двух синхронных вторичных реплик.
-   Начиная с версии 1706 число и тип реплик, которые вы можете включить в группу доступности, определяются характеристиками используемой версии SQL Server.

    Вы можете использовать реплику с асинхронной фиксацией для восстановления синхронных реплик. Сведения о том, как это сделать, см. в описании [параметров восстановления базы данных сайта]( /sccm/protect/understand/backup-and-recovery#BKMK_SiteDatabaseRecoveryOption) в статье о резервном копировании и восстановлении.
    > [!CAUTION]  
    > Configuration Manager не поддерживает использование реплики с асинхронной фиксацией в качестве базы данных сайта при отработке отказа.
Так как Configuration Manager не проверяет состояние и актуальность реплики с асинхронной фиксацией, которая [в силу конструктивных особенностей может быть не синхронизирована]( https://msdn.microsoft.com/library/ff877884(SQL.120).aspx(d=robot)#Availability%20Modes), использование такой реплики в качестве базы данных сайта может нарушить целостность сайта или данных.

Каждый член реплики:
-   должен использовать **экземпляр по умолчанию**;  
    *Начиная с версии 1702 можно использовать* ***именованные экземпляры***.

-     должен иметь установленное значение **Да** для параметра **Соединения в первичной роли**;
-     должен иметь установленное значение **Да** для параметра **Вторичная реплика для чтения**;  
-     должна быть настроена для **отработки отказа вручную**.      

    >  [!TIP]
    >  Configuration Manager поддерживает использование синхронных реплик группы доступности, если настроена **автоматическая отработка отказа**. Но в некоторых случаях должен быть настроен **переход на другой ресурс вручную**, например:
    >  -  если вы запустили программу установки, чтобы настроить использование базы данных сайта в группе доступности;
    >  -  если вы установили любое обновление Configuration Manager (даже не имеющее отношения к базе данных сайта).  

**Расположение члена реплики.**  
Все реплики в группе доступности должны размещаться только локально или только в Microsoft Azure. Не поддерживается создание групп, включающих одновременно локальные и облачные (Azure) члены.     

Если вы настраиваете группу доступности, которая располагается в Azure и за пределами внутренней или внешней подсистемы балансировки нагрузки, откройте перечисленные ниже порты по умолчанию для доступа программы установки к каждой реплике.   

-     Сопоставитель конечных точек RPC: **порт TCP 135**.   
-     Протокол SMB: **порт TCP 445**.  
    *Этот порт можно удалить, когда перемещение базы данных завершится. Начиная с версии 1702 этот порт больше не требуется.*
-     SQL Server Service Broker: **порт TCP 4022**.
-     SQL по TCP: **порт TCP 1433**.   

После завершения программы установки должны оставаться открытыми следующие порты.
-     SQL Server Service Broker: **порт TCP 4022**.
-     SQL по TCP: **порт TCP 1433**.

Начиная с версии 1702 для этих конфигураций можно использовать настраиваемые порты. Необходимо использовать одинаковые порты на конечной точке и на всех репликах в группе доступности.


**Прослушиватель.**   
Группа доступности должна иметь минимум один **прослушиватель группы доступности**. Виртуальное имя этого прослушивателя применяется при настройке Configuration Manager для использования базы данных сайта в группе доступности. Хотя группа доступности может содержать несколько прослушивателей, Configuration Manager может использовать только один. См. дополнительные сведения о [создании или настройке прослушивателя группы доступности (SQL Server)](/sql/database-engine/availability-groups/windows/create-or-configure-an-availability-group-listener-sql-server).

**Пути к файлам.**   
Когда вы запускаете программу установки Configuration Manager, чтобы настроить сайт для использования базы данных в группе доступности, на каждом сервере вторичной реплики в группе должен существовать такой же путь к файлам SQL Server, который указан для базы данных сайта на текущей первичной реплике.
-   Если такой путь не существует, программе установки не удастся добавить этот экземпляр группы доступности в качестве нового расположения базы данных сайта.
-   Кроме того, локальной учетной записи службы SQL Server должно быть назначено разрешение **Полный доступ** для этой папки.

Этот путь к файлам требуется вторичным серверам-репликам, только когда вы используете программу установки, чтобы указать экземпляр базы данных в группе доступности. Когда программа установки закончит настройку для использования базы данных сайта в группе доступности, вы можете удалить неиспользуемый путь с серверов вторичной реплики.

Например, рассмотрим следующий сценарий.
-   Вы создали группу доступности, которая использует три сервера SQL Server.

-   Сервер первичной реплики является новой установкой SQL Server 2014. По умолчанию файлы базы данных .mdf и .ldf хранятся в следующем расположении: C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA.

-   Оба сервера вторичной реплики обновлены до SQL Server 2014 с сохранением исходного пути для хранения файлов базы данных (C:\Program Files\Microsoft SQL Server\MSSQL10.MSSQLSERVER\MSSQL\DATA).

-   Перед попыткой переместить базу данных сайта в эту группу доступности на каждом сервере вторичной реплики необходимо создать следующий путь к файлу, даже если вторичные реплики не будут использовать это расположение: C:\Program Files\Microsoft SQL Server\MSSQL12.MSSQLSERVER\MSSQL\DATA (это дубликат пути, который используется на сайте первичной реплики).

-   Теперь на каждом сервере вторичной реплики предоставьте учетной записи службы SQL Server полный доступ к только что созданному расположению.

-   После этого можно запустить программу установки Configuration Manager, чтобы настроить на сайте использование базы данных сайта, размещенной в группе доступности.

**Настройка сервера реплики базы данных.**   
 Для базы данных на каждой реплике должны быть установлены следующие параметры:
-   **интеграция со средой CLR** должна быть *включена*;
-     параметр **Max text repl size** должен иметь значение *2147483647*;
-     владельцем базы данных должна являться *учетная запись SA*;
-     параметр **TRUSTWORTY** должен иметь значение **ON**;
-     **компонент Service Broker** должен быть *включен*.

Эти настройки можно изменять только на первичной реплике. Чтобы настроить вторичную реплику, необходимо выполнить отработку отказа с первичной на вторичную реплику, чтобы вторичная реплика стала новой первичной репликой.   

Дополнительные сведения о настройке параметров см. в документации по SQL Server. Например, эти разделы документации по SQL Server посвящены параметрам [TRUSTWORTHY](/sql/relational-databases/security/trustworthy-database-property) и [интеграции со средой CLR](/sql/relational-databases/clr-integration/clr-integration-enabling).

### <a name="verification-script"></a>Скрипт проверки
Вы можете выполнить следующий скрипт, чтобы проверить конфигурацию базы данных на первичной и вторичной репликах. Прежде чем устранять проблемы на вторичной реплике, необходимо сделать эту вторичную реплику первичной.

    SET NOCOUNT ON

    DECLARE @dbname NVARCHAR(128)

    SELECT @dbname = sd.name FROM sys.sysdatabases sd WHERE sd.dbid = DB_ID()

    IF (@dbname = N'master' OR @dbname = N'model' OR @dbname = N'msdb' OR @dbname = N'tempdb' OR @dbname = N'distribution' ) BEGIN
    RAISERROR(N'ERROR: Script is targetting a system database.  It should be targeting the DB you created instead.', 0, 1)
    GOTO Branch_Exit;
    END ELSE
    PRINT N'INFO: Targetted database is ' + @dbname + N'.'

    PRINT N'INFO: Running verifications....'

    IF NOT EXISTS (SELECT * FROM sys.configurations c WHERE c.name = 'clr enabled' AND c.value_in_use = 1)
    PRINT N'ERROR: CLR is not enabled!'
    ELSE
    PRINT N'PASS: CLR is enabled.'

    DECLARE @repltable TABLE (
    name nvarchar(max),
    minimum int,
    maximum int,
    config_value int,
    run_value int )

    INSERT INTO @repltable
    EXEC sp_configure 'max text repl size (B)'

    IF NOT EXISTS(SELECT * from @repltable where config_value = 2147483647 and run_value = 2147483647 )
    PRINT N'ERROR: Max text repl size is not correct!'
    ELSE
    PRINT N'PASS: Max text repl size is correct.'

    IF NOT EXISTS (SELECT db.owner_sid FROM sys.databases db WHERE db.database_id = DB_ID() AND db.owner_sid = 0x01)
    PRINT N'ERROR: Database owner is not sa account!'
    ELSE
    PRINT N'PASS: Database owner is sa account.'

    IF NOT EXISTS( SELECT * FROM sys.databases db WHERE db.database_id = DB_ID() AND db.is_trustworthy_on = 1 )
    PRINT N'ERROR: Trustworthy bit is not on!'
    ELSE
    PRINT N'PASS: Trustworthy bit is on.'

    IF NOT EXISTS( SELECT * FROM sys.databases db WHERE db.database_id = DB_ID() AND db.is_broker_enabled = 1 )
    PRINT N'ERROR: Service broker is not enabled!'
    ELSE
    PRINT N'PASS: Service broker is enabled.'

    IF NOT EXISTS( SELECT * FROM sys.databases db WHERE db.database_id = DB_ID() AND db.is_honor_broker_priority_on = 1 )
    PRINT N'ERROR: Service broker priority is not set!'
    ELSE
    PRINT N'PASS: Service broker priority is set.'

    PRINT N'Done!'

    Branch_Exit:

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы
На все сценарии распространяются указанные ниже ограничения.   

**Базовые группы доступности не поддерживаются.**  
Начиная с SQL Server 2016 выпуска Standard [базовые группы доступности](https://msdn.microsoft.com/library/mt614935.aspx) не поддерживают доступ для чтения ко вторичным репликам, который необходим для взаимодействия с Configuration Manager.

**Серверы SQL, на которых размещаются дополнительные группы доступности.**   
Группа доступности на узлах SQL Server может размещать одну или несколько дополнительных групп доступности, кроме используемой для Configuration Manager. В таком случае перед установкой Configuration Manager версии 1610 необходимо указать для каждой из дополнительных групп доступности представленный ниже набор настроек. Только после этого можно будет запускать программу настройки Configuration Manager или устанавливать обновление для Configuration Manager.
-   **отработки отказа вручную**
-   **разрешения любого подключения только для чтения**

**Неподдерживаемые сценарии использования базы данных.**
-   **Configuration Manager позволяет использовать в группе доступности только базу данных сайта.** Не поддерживается:
    -   база данных отчетов;
    -   база данных WSUS.
-   **Существующие базы данных.** Нельзя использовать новую базу данных, созданную в реплике. Вместо этого при настройке группы доступности необходимо восстановить на первичной реплике копию существующей базы данных Configuration Manager.

**Ошибки установки в файле ConfigMgrSetup.log.**  
Когда вы выполняете программу установки для перемещения базы данных сайта в группу доступности, программа установки пытается обработать роли базы данных на вторичных репликах группы доступности и записывает ошибки следующим образом:
-   ОШИБКА. Ошибка SQL Server: [25000][3906][Microsoft][SQL Server Native Client 11.0][SQL Server] Не удалось обновить базу данных "CM_AAA", так как она предназначена только для чтения. Configuration Manager Setup 1/21/2016 4:54:59 PM 7344 (0x1CB0)  

Эти ошибки можно спокойно игнорировать.

## <a name="changes-for-site-backup"></a>Изменения, относящиеся к резервному копированию сайта
**Файлы резервной копии базы данных .**  
Если база данных сайта работает в группе доступности, следует запускать встроенную задачу обслуживания **Резервное копирование сайта**, которая создает резервные копии основных параметров и файлов Configuration Manager. Но не планируйте использовать файлы с расширением .mdf или .ldf, созданные этой задачей резервного копирования. Вместо этого создавайте прямые резервные копии базы данных сайта средствами SQL Server.

**Журнал транзакций.**  
Для модели восстановления базы данных сайта необходимо выбрать режим **Полное** (это необходимо для групп доступности). В такой конфигурации важно следить за размером журнала транзакций базы данных сайта и корректировать его по мере необходимости. В модели полного восстановления транзакции не защищены, пока не создана полная резервная копия базы данных или журнала транзакций. См. дополнительные сведения о [резервном копировании и восстановлении баз данных SQL Server](/sql/relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases) в документации по SQL Server.

## <a name="changes-for-site-recovery"></a>Изменения, относящиеся к восстановлению сайта
При восстановлении сайта вы можете использовать вариант **Пропустить восстановление базы данных (используйте этот параметр, если база данных сайта не затронута)**, если функционирует хотя бы один узел группы доступности.

 Но если все узлы группы доступности стали недоступными, перед восстановлением сайта необходимо повторно создать группу доступности. Configuration Manager не может самостоятельно создавать или восстанавливать узлы доступности. Когда группа будет повторно создана, а резервная копия восстановлена и настроена, вы можете выполнить восстановление сайта в режиме **Пропустить восстановление базы данных (используйте этот параметр, если база данных сайта не затронута)**.

Дополнительные сведения см. в разделе [Резервное копирование и восстановление в System Center Configuration Manager](/sccm/protect/understand/backup-and-recovery).

## <a name="changes-for-reporting"></a>Изменения, относящиеся к отчетам
**Установка точки служб отчетов.**  
Точка служб отчетов не поддерживает использование виртуального имени прослушивателя для группы доступности или размещение базы данных служб отчетов в группе доступности AlwaysOn в SQL Server.
-   По умолчанию при установке точки служб отчетов для параметра **Имя сервера базы данных сайта** устанавливается виртуальное имя, указанное для прослушивателя. Измените этот параметр, чтобы указать имя компьютера и экземпляр реплики в группе доступности.
-   Чтобы снизить нагрузку, связанную с отчетами, и повысить доступность узла реплики в автономном режиме, мы рекомендуем установить дополнительные точки служб отчетов на каждом узле реплики и настроить каждую точку служб отчетов так, чтобы она указывала на собственное имя компьютера.

Если вы установите точку служб отчетов на каждой реплике в группе доступности, служба отчетов всегда сможет связаться с активным сервером точки служб отчетов.

**Изменение используемой точки служб отчетов с помощью консоли.**  
Чтобы запустить отчеты, перейдите в консоли к разделу **Мониторинг** > **Обзор** > **Компонент для создания отчетов** > **Отчеты**и нажмите кнопку **Параметры отчета**. В диалоговом окне параметров отчета выберите нужные точки служб отчетов.

## <a name="next-steps"></a>Дальнейшие действия
Когда вы ознакомитесь с предварительными требованиями, ограничениями и изменениями в типичных задачах, которые выполняются при использовании групп доступности, переходите к инструкциям по [настройке групп доступности для Configuration Manager](/sccm/core/servers/deploy/configure/configure-aoag). Вы узнаете, как устанавливать и настраивать сайты для использования групп доступности.
