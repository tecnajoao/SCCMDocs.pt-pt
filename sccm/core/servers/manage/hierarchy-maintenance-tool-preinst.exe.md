---
title: "Средство обслуживания иерархии | Документы Майкрософт"
description: "Сведения о действиях, выполняемых средством обслуживания иерархии, и его назначении. Включает справочник по параметрам командной строки."
ms.custom: na
ms.date: 10/06/2016
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-other
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: cead6825-6113-4ba5-a381-ac3598dfee86
caps.latest.revision: "7"
caps.handback.revision: "0"
author: Brenduns
ms.author: brenduns
manager: angrobe
ms.openlocfilehash: f3ddeaadfb1418aeeaacdca47768600c86b59083
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2017
---
# <a name="hierarchy-maintenance-tool-preinstexe-for-system-center-configuration-manager"></a>Средство обслуживания иерархии (Preinst.exe) в System Center Configuration Manager

*Применимо к: System Center Configuration Manager (Current Branch)*

Средство обслуживания иерархии (Preintst.exe) передает команды диспетчеру иерархии System Center Configuration Manager, пока работает служба диспетчера иерархии. Средство обслуживания иерархии устанавливается автоматически при установке сайта Configuration Manager. Файл Preinst.exe находится в общей папке \\&lt;*Имя_сервера_сайта*>\SMS_&lt;*Код_сайта*\bin\X64\00000409 на сервере сайта.  

 Средство обслуживания иерархии применяется в следующих ситуациях.  

-   В некоторых случаях, когда требуется безопасный обмен ключами, первоначальный обмен открытыми ключами между сайтами должен осуществляться вручную. Дополнительные сведения см. в разделе [Обмен открытыми ключами между сайтами, осуществляемый вручную](#BKMK_ManuallyExchangeKeys) этой статьи.  

-   Чтобы удалить активные задания для конечного сайта, которого больше не существует.  

-   Чтобы удалить сервер сайта из консоли Configuration Manager при невозможности удаления сайта с помощью программы установки. Например, если физически удалить сайт Configuration Manager без предварительного запуска программы установки с целью удаления сайта, сведения о сайте останутся в базе данных родительского сайта, и родительский сайт продолжит попытки подключения к дочернему сайту. Чтобы устранить эту проблему, следует запустить средство обслуживания иерархии и вручную удалить дочерний сайт из базы данных родительского сайта.  

-   Чтобы остановить все службы Configuration Manager на сайте без необходимости останавливать каждую службу по отдельности.  

-   При восстановлении сайта можно с помощью параметра CHILDKEYS распространить открытые ключи из нескольких дочерних сайтов на восстанавливаемый сайт.  

Для запуска средства обслуживания иерархии текущему пользователю необходимы привилегии администратора на локальном компьютере. Кроме того, пользователю должно быть явным образом предоставлено право "Сайт — администрирование"; если пользователь унаследовал это разрешение, являясь членом группы, которой оно предоставлено, этого недостаточно.  

## <a name="hierarchy-maintenance-tool-command-line-options"></a>Параметры командной строки средства обслуживания иерархии  
Средство обслуживания иерархии необходимо запускать локально на сервере сайта центра администрирования, первичного сайта или вторичного сайта.  

При запуске средства обслуживания иерархии используется следующий синтаксис: preinst.exe /&lt;параметр\>. Ниже приведены параметры командной строки.  

 **/DELJOB &lt;*код_сайта*>**. Используйте этот параметр на сайте, чтобы удалить все задания или команды, инициированные с текущего сайта в отношении указанного конечного сайта.  

 **/DELSITE &lt;*код_удаляемого_подчиненного_сайта*>**. Используйте этот параметр на родительском сайте, чтобы удалить данные подчиненных сайтов из базы данных родительского сайта. Как правило, этот параметр используется перед удалением сайта с компьютера сервера, который подлежит списанию.  

> [!NOTE]  
>  Параметр /DELSITE не удаляет сайт на компьютере, указанном в параметре ChildSiteCodeToRemove. Он лишь удаляет сведения о сайте из базы данных сайта Configuration Manager.  

**/DUMP &lt;*код_сайта*>**. Используйте этот параметр на локальном сервере сайта для записи образов параметров сайта в корневую папку диска, на котором сайт установлен. Можно записать определенный образ параметров сайта в папку, или же записать все файлы параметров сайта в иерархии.  

-   Параметр /DUMP &lt;*Код_сайта*> задает запись образа параметров только для определенного сайта.  

-   Параметр /DUMP приводит к записи файлов параметров всех сайтов.  

Образ является двоичным представлением файла параметров сайта, которое хранится в базе данных сайта Configuration Manager. Образ файла параметров сайта, для которого был создан дамп, является суммой базового образа и зависимых дельта-образов.  

После создания образа файла параметров сайта с помощью средства обслуживания иерархии имя файла записывается в формате sitectrl_&lt;*Код_сайта*>.ct0.  

**/STOPSITE**. Используйте этот параметр на локальном сервере сайта, чтобы запустить цикл завершения работы службы для диспетчера компонентов сайта Configuration Manager, в ходе которого происходит частичный сброс сайта. При запуске такого цикла завершения работы происходит остановка некоторых служб Configuration Manager на сервере сайта и его удаленных системах сайта. Эти службы обозначаются как подлежащие повторной установке. В результате этого цикла завершения работы происходит автоматическая смена некоторых паролей во время повторной установки служб.  

> [!NOTE]  
>  Чтобы получить возможность просмотра записей о завершении работы, повторной установке и изменениях паролей для диспетчера компонентов сайта, включите ведение журнала для соответствующего компонента перед использованием данного параметра командной строки.  

После запуска цикла завершения работы он продолжает выполняться автоматически, пропуская все не отвечающие компоненты или компьютеры. Однако если службе диспетчера компонентов сайта не удается получить доступ к удаленной системе сайта во время цикла завершения работы, компоненты, установленные в удаленной системе сайта, устанавливаются повторно при повторном запуске диспетчера компонентов сайта. После повторного запуска служба диспетчера компонентов сайта предпринимает многочисленные попытки переустановки всех служб, отмеченных в ней как подлежащие переустановке, до тех пор, пока ей это не удастся.  

Службу диспетчера компонентов сайта можно перезапустить с помощью диспетчера служб. После перезапуска все затронутые службы удаляются, устанавливаются повторно и перезапускаются. В результате применения параметра /STOPSITE для инициирования цикла завершения работы выполнение циклов повторной установки после перезапуска службы диспетчера компонентов сайта становится неизбежным.  

**/KEYFORPARENT**. Используйте этот параметр на сайте, чтобы распространить открытый ключ сайта на родительский сайт.  

Параметр /KEYFORPARENT помещает открытый ключ сайта в файл с именем &lt;*Код_сайта*>.CT4, расположенный в корне диска с файлами программы. После запуска файла preinst.exe с этим параметром следует вручную скопировать файл &lt;*Код_сайта*>.CT4 в папку …\Inboxes\hman.box на родительском сайте (но не в папку hman.box\pubkey).  

**/KEYFORCHILD**. Используйте этот параметр на сайте, чтобы распространить открытый ключ сайта на подчиненный сайт.  

Параметр /KEYFORCHILD помещает открытый ключ сайта в файл с именем &lt;*Код_сайта*>.CT5, расположенный в корне диска с файлами программы. После запуска файла preinst.exe с этим параметром следует вручную скопировать файл &lt;*Код_сайта*>.CT5 в папку …\Inboxes\hman.box на подчиненном сайте (но не в папку hman.box\pubkey).  

**/CHILDKEYS**. Этот параметр можно использовать на подчиненных сайтах того сайта, для которого выполняется восстановление. Он служит для передачи открытых ключей с нескольких дочерних сайтов на восстанавливаемый сайт.  

Параметр /CHILDKEYS помещает ключ сайта, на котором выполняется команда, и все остальные открытые ключи подчиненных сайтов в файл &lt;*Код_сайта*>.CT6.  

После запуска файла preinst.exe с этим параметром следует вручную скопировать файл &lt;*Код_сайта*>.CT6 в папку …\Inboxes\hman.box на восстанавливаемом сайте (но не в папку hman.box\pubkey).  

**/PARENTKEYS**. Этот параметр можно использовать на родительском сайте восстанавливаемого сайта. Он служит для передачи открытых ключей со всех родительских сайтов на восстанавливаемый сайт.  

Параметр /PARENTKEYS помещает ключ сайта, на котором выполняется команда, и ключи всех его родительских сайтов в файл &lt;Код_сайта\>.CT7.  

После запуска файла preinst.exe с этим параметром следует вручную скопировать файл &lt;*Код_сайта*>.CT7 в папку …\Inboxes\hman.box на восстанавливаемом сайте (но не в папку hman.box\pubkey).  

##  <a name="BKMK_ManuallyExchangeKeys"></a> Обмен открытыми ключами между сайтами, осуществляемый вручную  
На сайтах Configuration Manager по умолчанию включен параметр **Требовать обмен ключами безопасности**. Существуют две ситуации, когда требуется безопасный обмен ключами, и первоначальный обмен ключами между сайтами должен осуществляться вручную.  

-   Если схема Active Directory не была расширена для Configuration Manager  

-   Сайты Configuration Manager не публикуют данные сайтов в службе каталогов Active Directory  

С помощью средства обслуживания иерархии можно экспортировать открытые ключи каждого сайта. После экспорта следует вручную выполнить обмен ключами между сайтами.  

> [!NOTE]  
>  Выполнив обмен открытыми ключами вручную, можно на сервере родительского сайта просмотреть файл журнала **hman.log** , в который заносятся изменения конфигурации сайта, а также данные, опубликованные в доменных службах Active Directory, чтобы убедиться, что сайт обработал новый открытый ключ.  

#### <a name="to-manually-transfer-the-child-site-public-key-to-the-parent-site"></a>Передача вручную открытого ключа дочернего сайта родительскому сайту  

1.  Находясь в системе дочернего сайта, откройте командную строку и перейдите в расположение файла **Preinst.exe**.  

2.  Чтобы экспортировать открытый ключ подчиненного сайта, введите: **Preinst /keyforparent**  

3.  Параметр /keyforparent помещает открытый ключ подчиненного сайта в файл с именем **&lt;код_сайта\>.CT4**, расположенный в корне системного диска.  

4.  Переместите файл с именем **&lt;код_сайта\>.CT4** в папку **&lt;каталог_установки\>\inboxes\hman.box** родительского сайта.  

#### <a name="to-manually-transfer-the-parent-site-public-key-to-the-child-site"></a>Передача вручную открытого ключа родительского сайта дочернему сайту  

1.  Находясь в системе родительского сайта, откройте командную строку и перейдите в расположение файла **Preinst.exe**.  

2.  Чтобы экспортировать открытый ключ родительского сайта, введите: **Preinst /keyforchild**.  

3.  Параметр /keyforchild помещает открытый ключ родительского сайта в файл с именем **&lt;код_сайта\>.CT5**, расположенный в корне системного диска.  

4.  Переместите файл с именем **&lt;код_сайта\>.CT5** в папку **&lt;каталог_установки\>\inboxes\hman.box** подчиненного сайта.  
